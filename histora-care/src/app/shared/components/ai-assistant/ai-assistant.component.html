<!-- FAB Button -->
@if (!isOpen) {
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button color="primary" (click)="openAssistant()" aria-label="Abrir Asistente Hana">
      <ion-icon name="sparkles"></ion-icon>
    </ion-fab-button>
  </ion-fab>
}

<!-- Full Screen Modal -->
@if (isOpen) {
  <div class="ai-overlay" (click)="closeAssistant()">
    <div class="ai-container" (click)="$event.stopPropagation()">
      <!-- Edge Glow Effect -->
      <div class="edge-glow"
        [class.listening]="state === 'listening' || isListening"
        [class.processing]="state === 'processing'"
        [class.speaking]="state === 'speaking'">
      </div>
      <!-- Header -->
      <div class="ai-header">
        <div class="ai-avatar" [class.active]="state !== 'inactive'">
          <ion-icon name="sparkles"></ion-icon>
        </div>
        <div class="ai-title-wrapper">
          <h2 class="ai-title">Hana</h2>
          <span class="ai-subtitle">Asistente de Salud</span>
        </div>
        <ion-button fill="clear" (click)="closeAssistant()" aria-label="Cerrar">
          <ion-icon slot="icon-only" name="close"></ion-icon>
        </ion-button>
      </div>
      <!-- Status -->
      <div class="ai-status">
        @if (isListening) {
          <span class="status-badge listening">
            <span class="voice-wave">
              <span class="bar"></span>
              <span class="bar"></span>
              <span class="bar"></span>
            </span>
            Escuchando...
          </span>
        }
        @if (state === 'processing') {
          <span class="status-badge processing">
            <ion-spinner name="dots" color="primary"></ion-spinner>
            Pensando...
          </span>
        }
        @if (state === 'speaking') {
          <span class="status-badge speaking">
            <ion-icon name="volume-high"></ion-icon>
            Hablando...
          </span>
        }
      </div>
      <!-- Chat Container -->
      <div #chatContent class="chat-container">
        <!-- Welcome Message -->
        @if (messages.length === 0) {
          <div class="welcome-message">
            <div class="welcome-icon">
              <ion-icon name="sparkles"></ion-icon>
            </div>
            <h3>¡Hola! Soy Hana</h3>
            <p>Tu asistente de salud virtual. ¿En qué puedo ayudarte?</p>
            <!-- Quick Actions -->
            <div class="quick-actions">
              @for (action of suggestedActions; track action) {
                <ion-chip
                  color="primary"
                  outline="true"
                  (click)="sendMessage(action.command)">
                  <ion-icon [name]="action.icon"></ion-icon>
                  <ion-label>{{ action.label }}</ion-label>
                </ion-chip>
              }
            </div>
          </div>
        }
        <!-- Messages -->
        @for (message of messages; track trackByMessageId($index, message)) {
          <div
            class="message-wrapper"
            [class.user]="message.role === 'user'"
            [class.assistant]="message.role === 'assistant'">
            <div class="chat-bubble">
              <p>{{ message.content }}</p>
              <!-- Suggestions -->
              @if (message.suggestions?.length) {
                <div class="suggestions">
                  @for (suggestion of message.suggestions; track suggestion) {
                    <ion-chip
                      size="small"
                      (click)="sendMessage(suggestion)">
                      {{ suggestion }}
                    </ion-chip>
                  }
                </div>
              }
            </div>
            <span class="message-time">
              {{ message.timestamp | date:'shortTime' }}
            </span>
          </div>
        }
        <!-- Processing Indicator -->
        @if (state === 'processing') {
          <div class="message-wrapper assistant">
            <div class="chat-bubble typing">
              <span class="dot"></span>
              <span class="dot"></span>
              <span class="dot"></span>
            </div>
          </div>
        }
      </div>
      <!-- Input Area -->
      <div class="input-container">
        @if (showVoiceButton) {
          <ion-button
            fill="clear"
            [class.active]="isListening"
            (click)="toggleVoiceInput()"
            aria-label="Entrada de voz">
            <ion-icon slot="icon-only" [name]="isListening ? 'mic' : 'mic-outline'"
            [color]="isListening ? 'danger' : 'medium'"></ion-icon>
          </ion-button>
        }
        <ion-textarea
          [(ngModel)]="currentMessage"
          (keydown)="handleKeyDown($event)"
          placeholder="Escribe tu mensaje..."
          [autoGrow]="true"
          rows="1"
          [disabled]="state === 'processing'">
        </ion-textarea>
        <ion-button fill="clear"
          [disabled]="!currentMessage.trim() || state === 'processing'"
          (click)="sendMessage()"
          aria-label="Enviar">
          <ion-icon slot="icon-only" name="send" color="primary"></ion-icon>
        </ion-button>
      </div>
    </div>
  </div>
}
