<ion-header>
  <ion-toolbar>
    <ion-title>Enfermeras Cercanas</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()" aria-label="Cerrar">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="nurses-count ion-padding-horizontal ion-padding-top">
    <ion-icon name="people-outline"></ion-icon>
    <span>{{ nurses.length }} {{ nurses.length === 1 ? 'enfermera encontrada' : 'enfermeras encontradas' }}</span>
  </div>

  <!-- Virtual scroll for large lists (20+ items) -->
  @if (nurses.length >= 20) {
    <cdk-virtual-scroll-viewport itemSize="140" class="virtual-scroll-viewport">
      <div class="nurse-list virtual-list">
        @for (result of nurses; track result) {
          <div class="nurse-item-wrapper" (click)="selectNurse(result)">
            <div class="nurse-item-content">
              <div class="nurse-avatar-container">
                <ion-avatar>
                  <img [src]="result.nurse.user?.avatar || 'assets/img/default-avatar.png'"
                    [alt]="result.nurse.user?.firstName"
                    loading="lazy">
                </ion-avatar>
                @if (result.nurse.isAvailable) {
                  <span class="availability-dot"></span>
                }
              </div>
              <div class="nurse-details">
                <div class="nurse-header">
                  <h3>{{ result.nurse.user?.firstName }} {{ result.nurse.user?.lastName }}</h3>
                  <span class="availability-badge" [class.available]="result.nurse.isAvailable">
                    {{ result.nurse.isAvailable ? 'Disponible' : 'No disponible' }}
                  </span>
                </div>
                <div class="nurse-meta">
                  <span class="distance">
                    <ion-icon name="location-outline"></ion-icon>
                    {{ result.distance.toFixed(1) }} km
                  </span>
                  @if (result.nurse.averageRating > 0) {
                    <span class="rating">
                      <ion-icon name="star"></ion-icon>
                      {{ result.nurse.averageRating.toFixed(1) }}
                      <span class="reviews">({{ result.nurse.totalReviews }})</span>
                    </span>
                  }
                </div>
                @if (result.nurse.specialties?.length) {
                  <div class="nurse-specialties">
                    @for (specialty of result.nurse.specialties.slice(0, 2); track specialty) {
                      <span class="specialty-chip" [style]="getChipStyle(specialty)">
                        <ion-icon [name]="getChipIcon(specialty)"></ion-icon>
                        {{ specialty }}
                      </span>
                    }
                    @if (result.nurse.specialties.length > 2) {
                      <span class="more-count">
                        +{{ result.nurse.specialties.length - 2 }}
                      </span>
                    }
                  </div>
                }
                @if (result.nurse.services?.length) {
                  <div class="nurse-price">
                    <span class="from">Desde</span>
                    <span class="price">S/ {{ getMinPrice(result.nurse.services) }}</span>
                  </div>
                }
              </div>
              <ion-icon name="chevron-forward" class="arrow-icon"></ion-icon>
            </div>
          </div>
        }
      </div>
    </cdk-virtual-scroll-viewport>
  }

  <!-- Standard list for smaller lists (<20 items) -->
  @if (nurses.length > 0 && nurses.length < 20) {
    <ion-list lines="none" class="nurse-list">
      @for (result of nurses; track result) {
        <ion-item button detail="false" (click)="selectNurse(result)">
          <div class="nurse-item-content">
            <div class="nurse-avatar-container">
              <ion-avatar>
                <img [src]="result.nurse.user?.avatar || 'assets/img/default-avatar.png'"
                  [alt]="result.nurse.user?.firstName"
                  loading="lazy">
              </ion-avatar>
              @if (result.nurse.isAvailable) {
                <span class="availability-dot"></span>
              }
            </div>
            <div class="nurse-details">
              <div class="nurse-header">
                <h3>{{ result.nurse.user?.firstName }} {{ result.nurse.user?.lastName }}</h3>
                <span class="availability-badge" [class.available]="result.nurse.isAvailable">
                  {{ result.nurse.isAvailable ? 'Disponible' : 'No disponible' }}
                </span>
              </div>
              <div class="nurse-meta">
                <span class="distance">
                  <ion-icon name="location-outline"></ion-icon>
                  {{ result.distance.toFixed(1) }} km
                </span>
                @if (result.nurse.averageRating > 0) {
                  <span class="rating">
                    <ion-icon name="star"></ion-icon>
                    {{ result.nurse.averageRating.toFixed(1) }}
                    <span class="reviews">({{ result.nurse.totalReviews }})</span>
                  </span>
                }
              </div>
              @if (result.nurse.specialties?.length) {
                <div class="nurse-specialties">
                  @for (specialty of result.nurse.specialties.slice(0, 2); track specialty) {
                    <span class="specialty-chip" [style]="getChipStyle(specialty)">
                      <ion-icon [name]="getChipIcon(specialty)"></ion-icon>
                      {{ specialty }}
                    </span>
                  }
                  @if (result.nurse.specialties.length > 2) {
                    <span class="more-count">
                      +{{ result.nurse.specialties.length - 2 }}
                    </span>
                  }
                </div>
              }
              @if (result.nurse.services?.length) {
                <div class="nurse-price">
                  <span class="from">Desde</span>
                  <span class="price">S/ {{ getMinPrice(result.nurse.services) }}</span>
                </div>
              }
            </div>
            <ion-icon name="chevron-forward" class="arrow-icon"></ion-icon>
          </div>
        </ion-item>
      }
    </ion-list>
  }

  @if (nurses.length === 0) {
    <div class="empty-state">
      <ion-icon name="search-outline"></ion-icon>
      <h3>No hay enfermeras cercanas</h3>
      <p>Intenta ampliar el radio de b√∫squeda</p>
    </div>
  }
</ion-content>
