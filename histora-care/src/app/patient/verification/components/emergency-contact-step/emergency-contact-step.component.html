<div class="emergency-step">
  <div class="step-header">
    <div class="step-icon">
      <ion-icon name="people-outline"></ion-icon>
    </div>
    <h2>Contactos de emergencia</h2>
    <p>Agrega al menos 2 personas a las que podamos contactar en caso de emergencia.</p>
  </div>

  <form [formGroup]="form">
    <div formArrayName="contacts" class="contacts-list">
      @for (contact of contacts.controls; track $index; let i = $index) {
        <div class="contact-card" [formGroupName]="i">
          <div class="contact-header">
            <span class="contact-number">Contacto {{ i + 1 }}</span>
            @if (contacts.length > 2) {
              <ion-button fill="clear" color="danger" size="small" (click)="removeContact(i)" aria-label="Eliminar contacto">
                <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
              </ion-button>
            }
          </div>

          <div class="form-field">
            <ion-label>Nombre completo</ion-label>
            <ion-input
              formControlName="name"
              placeholder="Ej: Maria Garcia"
              [class.invalid]="getFieldError(i, 'name')">
            </ion-input>
            @if (getFieldError(i, 'name')) {
              <span class="field-error">{{ getFieldError(i, 'name') }}</span>
            }
          </div>

          <div class="form-field">
            <ion-label>Telefono</ion-label>
            <div class="phone-input-wrapper">
              <span class="phone-prefix">+51</span>
              <ion-input
                formControlName="phone"
                placeholder="987654321"
                type="tel"
                inputmode="numeric"
                [maxlength]="9"
                (ionInput)="formatPhone(i, $event)"
                [class.invalid]="getFieldError(i, 'phone')">
              </ion-input>
            </div>
            @if (getFieldError(i, 'phone')) {
              <span class="field-error">{{ getFieldError(i, 'phone') }}</span>
            }
          </div>

          <div class="form-field">
            <ion-label>Relacion</ion-label>
            <ion-select
              formControlName="relationship"
              placeholder="Seleccionar"
              interface="action-sheet"
              [class.invalid]="getFieldError(i, 'relationship')">
              @for (rel of relationships; track rel) {
                <ion-select-option [value]="rel">{{ rel }}</ion-select-option>
              }
            </ion-select>
            @if (getFieldError(i, 'relationship')) {
              <span class="field-error">{{ getFieldError(i, 'relationship') }}</span>
            }
          </div>
        </div>
      }
    </div>

    @if (canAddMore) {
      <ion-button expand="block" fill="outline" (click)="addContact()" class="add-btn">
        <ion-icon name="add-outline" slot="start"></ion-icon>
        Agregar otro contacto
      </ion-button>
    }
  </form>

  <div class="info-note">
    <ion-icon name="information-circle-outline"></ion-icon>
    <span>Estos contactos seran notificados solo en caso de emergencia durante un servicio.</span>
  </div>

  @if (error()) {
    <div class="error-message">
      <ion-icon name="alert-circle-outline"></ion-icon>
      {{ error() }}
    </div>
  }

  <div class="step-actions">
    <ion-button
      expand="block"
      [disabled]="!canSubmit || isLoading()"
      (click)="submitContacts()"
      class="primary-btn">
      @if (isLoading()) {
        <ion-spinner name="crescent"></ion-spinner>
      } @else {
        Guardar contactos
        <ion-icon name="checkmark-outline" slot="end"></ion-icon>
      }
    </ion-button>
  </div>
</div>
