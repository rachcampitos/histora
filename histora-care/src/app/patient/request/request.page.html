<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/patient/tabs/home" (click)="goBack()"></ion-back-button>
    </ion-buttons>
    <ion-title>Solicitar Servicio</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container" role="status" aria-live="polite">
      <ion-spinner name="crescent" aria-hidden="true"></ion-spinner>
      <p>Cargando servicios...</p>
    </div>
  }

  <!-- Error State -->
  @if (error() && !isLoading()) {
    <div class="error-container">
      <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
      <h3>{{ error() }}</h3>
      <ion-button (click)="goBack()" fill="outline">
        <ion-icon name="arrow-back" slot="start"></ion-icon>
        Volver
      </ion-button>
    </div>
  }

  <!-- Request Form -->
  @if (nurse() && !isLoading() && !error()) {
    <div class="request-form">
      <!-- Nurse Info Card -->
      <ion-card class="nurse-summary-card">
        <ion-card-content>
          <div class="nurse-summary">
            <div class="nurse-avatar">
              @if (nurse()!.user?.avatar) {
                <img [src]="nurse()!.user?.avatar" alt="Avatar" />
              } @else {
                <div class="avatar-placeholder">
                  <ion-icon name="person"></ion-icon>
                </div>
              }
            </div>
            <div class="nurse-info">
              <h2>{{ nurse()!.user?.firstName }} {{ nurse()!.user?.lastName }}</h2>
              <div class="nurse-meta">
                <span class="rating">
                  <ion-icon name="star" color="warning"></ion-icon>
                  {{ (nurse()!.averageRating || 0).toFixed(1) }}
                </span>
                @if (nurse()!.cepVerified) {
                  <ion-badge color="success" class="verified-badge">
                    <ion-icon name="checkmark-circle"></ion-icon>
                    Verificada
                  </ion-badge>
                }
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Service Selection -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="medkit-outline"></ion-icon>
            Seleccionar Servicio
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          @if (availableServices().length === 0) {
            <div class="no-services">
              <ion-icon name="medical-outline" color="medium"></ion-icon>
              <p>Esta enfermera no tiene servicios disponibles actualmente.</p>
            </div>
          } @else {
            <ion-radio-group [value]="selectedServiceId()" (ionChange)="onServiceChange($event)">
              <ion-list lines="none" class="services-list">
                @for (service of availableServices(); track service._id) {
                  <ion-item
                    button
                    [class.selected]="selectedServiceId() === service._id"
                    (click)="selectedServiceId.set(service._id || '')"
                  >
                    <ion-radio slot="start" [value]="service._id"></ion-radio>
                    <ion-label>
                      <h3>{{ service.name }}</h3>
                      <p>{{ getCategoryLabel(service.category) }} - {{ formatDuration(service.durationMinutes) }}</p>
                    </ion-label>
                    <ion-note slot="end" class="service-price">
                      {{ formatPrice(service.price, service.currency) }}
                    </ion-note>
                  </ion-item>
                }
              </ion-list>
            </ion-radio-group>
          }
        </ion-card-content>
      </ion-card>

      <!-- Location Section -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="location-outline"></ion-icon>
            Ubicacion del Servicio
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <!-- Location Mode Toggle -->
          <div class="location-toggle">
            <ion-segment [value]="useCurrentLocation() ? 'current' : 'manual'" (ionChange)="toggleLocationMode()">
              <ion-segment-button value="current">
                <ion-icon name="navigate-outline"></ion-icon>
                <ion-label>Ubicacion Actual</ion-label>
              </ion-segment-button>
              <ion-segment-button value="manual">
                <ion-icon name="create-outline"></ion-icon>
                <ion-label>Ingresar Direccion</ion-label>
              </ion-segment-button>
            </ion-segment>
          </div>

          <!-- Current Location -->
          @if (useCurrentLocation()) {
            <div class="current-location-section">
              @if (isLoadingLocation()) {
                <div class="location-loading">
                  <ion-spinner name="dots"></ion-spinner>
                  <span>Obteniendo ubicacion...</span>
                </div>
              } @else if (locationError()) {
                <div class="location-error">
                  <ion-icon name="warning-outline" color="warning"></ion-icon>
                  <span>{{ locationError() }}</span>
                  <ion-button fill="clear" size="small" (click)="refreshLocation()">
                    Reintentar
                  </ion-button>
                </div>
              } @else if (currentLocation()) {
                <div class="location-success">
                  <ion-icon name="checkmark-circle" color="success"></ion-icon>
                  <span>Ubicacion obtenida correctamente</span>
                  <ion-button fill="clear" size="small" (click)="refreshLocation()">
                    <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
                  </ion-button>
                </div>
              }

              <!-- Address Reference for Current Location -->
              <ion-item lines="none" class="reference-input">
                <ion-label position="stacked">Referencia (opcional)</ion-label>
                <ion-input
                  placeholder="Ayudanos a llegar facil: color de casa, edificio, etc."
                  [value]="addressReference()"
                  (ionInput)="addressReference.set($any($event).target.value)"
                ></ion-input>
              </ion-item>
            </div>
          }

          <!-- Manual Address -->
          @if (!useCurrentLocation()) {
            <div class="manual-address-section">
              <ion-item lines="none">
                <ion-label position="stacked">Direccion *</ion-label>
                <ion-input
                  placeholder="¿Donde te visitamos? Ej: Av. Javier Prado 1520"
                  [value]="manualAddress()"
                  (ionInput)="manualAddress.set($any($event).target.value)"
                  required
                ></ion-input>
              </ion-item>

              <ion-item lines="none">
                <ion-label position="stacked">Distrito *</ion-label>
                <ion-input
                  placeholder="Ej: San Isidro, Miraflores, Surco..."
                  [value]="manualDistrict()"
                  (ionInput)="manualDistrict.set($any($event).target.value)"
                  required
                ></ion-input>
              </ion-item>

              <ion-item lines="none">
                <ion-label position="stacked">Ciudad *</ion-label>
                <ion-input
                  placeholder="Lima"
                  [value]="manualCity()"
                  (ionInput)="manualCity.set($any($event).target.value)"
                  required
                ></ion-input>
              </ion-item>

              <ion-item lines="none">
                <ion-label position="stacked">Referencia (opcional)</ion-label>
                <ion-input
                  placeholder="Ayudanos a llegar facil: color de casa, edificio, etc."
                  [value]="addressReference()"
                  (ionInput)="addressReference.set($any($event).target.value)"
                ></ion-input>
              </ion-item>
            </div>
          }
        </ion-card-content>
      </ion-card>

      <!-- Date & Time Section -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="calendar-outline"></ion-icon>
            ¿Cuando te visitamos?
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p class="section-helper">La enfermera confirmara la hora exacta contigo antes de la visita.</p>
          <!-- Date Picker -->
          <ion-item lines="none" class="date-picker-item">
            <ion-label position="stacked">Fecha deseada *</ion-label>
            <ion-datetime-button datetime="request-date"></ion-datetime-button>
            <ion-modal [keepContentsMounted]="true">
              <ng-template>
                <ion-datetime
                  id="request-date"
                  presentation="date"
                  [min]="getMinDate()"
                  [max]="getMaxDate()"
                  [value]="requestedDate()"
                  (ionChange)="onDateChange($event)"
                  locale="es-PE"
                  [firstDayOfWeek]="1"
                >
                  <span slot="title">Seleccionar fecha</span>
                </ion-datetime>
              </ng-template>
            </ion-modal>
          </ion-item>

          <!-- Time Slot Selection -->
          <div class="time-slot-section">
            <ion-label class="time-slot-label">Horario preferido *</ion-label>
            <div class="time-slot-grid">
              @for (slot of timeSlotOptions; track slot.value) {
                <div
                  class="time-slot-option"
                  [class.selected]="requestedTimeSlot() === slot.value"
                  (click)="onTimeSlotChange(slot.value)"
                >
                  <ion-icon [name]="slot.icon"></ion-icon>
                  <span>{{ slot.label }}</span>
                </div>
              }
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Notes Section -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="document-text-outline"></ion-icon>
            Cuentanos mas (opcional)
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-textarea
            placeholder="¿Hay algo que debamos saber para cuidarte mejor? Alergias, medicamentos actuales, movilidad reducida, etc. Toda informacion nos ayuda a darte una mejor atencion."
            [value]="patientNotes()"
            (ionInput)="patientNotes.set($any($event).target.value)"
            [autoGrow]="true"
            [rows]="3"
            [maxlength]="500"
          ></ion-textarea>
          <div class="char-counter">
            {{ patientNotes().length }}/500
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Summary Card -->
      @if (selectedService()) {
        <ion-card class="summary-card">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="receipt-outline"></ion-icon>
              Resumen del Servicio
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list lines="none">
              <ion-item>
                <ion-label>
                  <p>Servicio</p>
                  <h3>{{ selectedService()!.name }}</h3>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-label>
                  <p>Duracion estimada</p>
                  <h3>{{ formatDuration(selectedService()!.durationMinutes) }}</h3>
                </ion-label>
              </ion-item>
              <ion-item class="total-item">
                <ion-label>
                  <h3>Total a pagar</h3>
                </ion-label>
                <ion-note slot="end" class="total-price">
                  {{ formatPrice(selectedService()!.price, selectedService()!.currency) }}
                </ion-note>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>
      }
    </div>
  }
</ion-content>

<!-- Submit Button Footer -->
@if (nurse() && !isLoading() && !error()) {
  <ion-footer class="ion-no-border">
    <ion-toolbar>
      <ion-button
        expand="block"
        (click)="submitRequest()"
        [disabled]="!isFormValid() || isSubmitting()"
      >
        @if (isSubmitting()) {
          <ion-spinner name="crescent" slot="start"></ion-spinner>
          Enviando...
        } @else {
          <ion-icon name="checkmark-circle" slot="start"></ion-icon>
          Confirmar Solicitud
        }
      </ion-button>
    </ion-toolbar>
  </ion-footer>
}
