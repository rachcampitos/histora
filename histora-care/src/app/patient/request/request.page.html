<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/patient/tabs/home" (click)="goBack()"></ion-back-button>
    </ion-buttons>
    <ion-title>Solicitar Servicio</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container" role="status" aria-live="polite">
      <ion-spinner name="crescent" aria-hidden="true"></ion-spinner>
      <p>Cargando servicios...</p>
    </div>
  }

  <!-- Error State -->
  @if (error() && !isLoading()) {
    <div class="error-container">
      <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
      <h3>{{ error() }}</h3>
      <ion-button (click)="goBack()" fill="outline">
        <ion-icon name="arrow-back" slot="start"></ion-icon>
        Volver
      </ion-button>
    </div>
  }

  <!-- Nurse Unavailable State (C2) -->
  @if (nurse() && !nurse()!.isAvailable && !isLoading() && !error()) {
    <div class="unavailable-state">
      <ion-icon name="calendar-clear-outline" color="medium"></ion-icon>
      <h3>Enfermera no disponible</h3>
      <p>{{ nurse()!.user?.firstName }} no esta recibiendo solicitudes en este momento.</p>
      <ion-button expand="block" (click)="searchOtherNurses()">
        <ion-icon name="search-outline" slot="start"></ion-icon>
        Buscar otras enfermeras
      </ion-button>
      <ion-button expand="block" fill="outline" (click)="goBack()">
        <ion-icon name="arrow-back" slot="start"></ion-icon>
        Volver al perfil
      </ion-button>
    </div>
  }

  <!-- Request Form -->
  @if (nurse() && nurse()!.isAvailable && !isLoading() && !error()) {
    <div class="request-form">
      <!-- Nurse Info Card -->
      <ion-card class="nurse-summary-card">
        <ion-card-content>
          <div class="nurse-summary">
            <div class="nurse-avatar">
              @if (nurse()!.user?.avatar) {
                <img [src]="nurse()!.user?.avatar" alt="Avatar" />
              } @else {
                <div class="avatar-placeholder">
                  <ion-icon name="person"></ion-icon>
                </div>
              }
            </div>
            <div class="nurse-info">
              <h2>{{ nurse()!.user?.firstName }} {{ nurse()!.user?.lastName }}</h2>
              <div class="nurse-meta">
                <span class="rating">
                  <ion-icon name="star" color="warning"></ion-icon>
                  {{ (nurse()!.averageRating || 0).toFixed(1) }}
                </span>
                @if (nurse()!.cepVerified) {
                  <ion-badge color="success" class="verified-badge">
                    <ion-icon name="checkmark-circle"></ion-icon>
                    Verificada
                  </ion-badge>
                }
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Service Selection -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="medkit-outline"></ion-icon>
            Seleccionar Servicio
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          @if (availableServices().length === 0) {
            <div class="no-services">
              <ion-icon name="medical-outline" color="medium"></ion-icon>
              <p>Esta enfermera no tiene servicios disponibles actualmente.</p>
            </div>
          } @else {
            <ion-radio-group [value]="selectedServiceId()" (ionChange)="onServiceChange($event)">
              <ion-list lines="none" class="services-list">
                @for (service of availableServices(); track service._id) {
                  <ion-item
                    button
                    detail="false"
                    [class.selected]="selectedServiceId() === service._id"
                    (click)="selectedServiceId.set(service._id || '')"
                  >
                    <ion-radio slot="start" [value]="service._id" mode="md"></ion-radio>
                    <ion-label>
                      <h3>{{ service.name }}</h3>
                      <p>{{ getCategoryLabel(service.category) }} - {{ formatDuration(service.durationMinutes) }}</p>
                    </ion-label>
                    <ion-note slot="end" class="service-price">
                      {{ formatPrice(service.price, service.currency) }}
                    </ion-note>
                  </ion-item>
                }
              </ion-list>
            </ion-radio-group>
            @if (!selectedServiceId() && availableServices().length > 1) {
              <p class="selection-hint">
                <ion-icon name="hand-left-outline"></ion-icon>
                Toca una opcion para continuar
              </p>
            }
          }
        </ion-card-content>
      </ion-card>

      <!-- Location Section -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="location-outline"></ion-icon>
            Ubicacion del Servicio
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <!-- Location Mode Toggle -->
          <div class="location-toggle">
            <ion-segment [value]="useCurrentLocation() ? 'current' : 'manual'" (ionChange)="toggleLocationMode()">
              <ion-segment-button value="current">
                <ion-icon name="navigate-outline"></ion-icon>
                <ion-label>Ubicacion Actual</ion-label>
              </ion-segment-button>
              <ion-segment-button value="manual">
                <ion-icon name="create-outline"></ion-icon>
                <ion-label>Ingresar Direccion</ion-label>
              </ion-segment-button>
            </ion-segment>
          </div>

          <!-- Current Location -->
          @if (useCurrentLocation()) {
            <div class="current-location-section">
              @if (isLoadingLocation()) {
                <div class="location-loading">
                  <ion-spinner name="dots"></ion-spinner>
                  <span>Obteniendo ubicacion...</span>
                </div>
              } @else if (locationError()) {
                <div class="location-error">
                  <ion-icon name="warning-outline" color="warning"></ion-icon>
                  <span>{{ locationError() }}</span>
                  <ion-button fill="clear" size="small" (click)="refreshLocation()">
                    Reintentar
                  </ion-button>
                </div>
              } @else if (currentLocation()) {
                <div class="location-success">
                  <ion-icon name="checkmark-circle" color="success"></ion-icon>
                  @if (resolvedAddress()) {
                    <span class="resolved-address">{{ resolvedAddress() }}</span>
                  } @else {
                    <span>Ubicacion obtenida correctamente</span>
                  }
                  <ion-button fill="clear" size="small" (click)="refreshLocation()" aria-label="Actualizar ubicacion">
                    <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
                  </ion-button>
                </div>
              }

              <!-- Address Reference for Current Location -->
              <ion-item lines="none" class="reference-input">
                <ion-input
                  label="Referencia (opcional)"
                  label-placement="stacked"
                  placeholder="Ayudanos a llegar facil: color de casa, edificio, etc."
                  [value]="addressReference()"
                  (ionInput)="onReferenceInput($any($event).target.value)"
                ></ion-input>
              </ion-item>
            </div>
          }

          <!-- Manual Address -->
          @if (!useCurrentLocation()) {
            <div class="manual-address-section">
              <ion-item lines="none">
                <ion-input
                  label="Direccion *"
                  label-placement="stacked"
                  placeholder="Ej: Av. Javier Prado 1520, San Isidro"
                  [value]="manualAddress()"
                  (ionInput)="onAddressInput($any($event).target.value)"
                  required
                ></ion-input>
              </ion-item>

              <!-- Address Suggestions -->
              @if (addressSuggestions().length > 0) {
                <div class="address-suggestions">
                  @for (suggestion of addressSuggestions(); track suggestion.id) {
                    <div class="suggestion-item" (click)="selectSuggestion(suggestion)">
                      <ion-icon name="location-outline" color="primary"></ion-icon>
                      <div class="suggestion-text">
                        <span class="suggestion-address">{{ suggestion.address }}</span>
                      </div>
                    </div>
                  }
                </div>
              }
              @if (isSearchingAddress()) {
                <div class="address-searching">
                  <ion-spinner name="dots" color="primary"></ion-spinner>
                  <span>Buscando direcciones...</span>
                </div>
              }

              <ion-item lines="none">
                <ion-input
                  label="Distrito *"
                  label-placement="stacked"
                  placeholder="Ej: San Isidro, Miraflores, Surco..."
                  [value]="manualDistrict()"
                  (ionInput)="onDistrictInput($any($event).target.value)"
                  required
                ></ion-input>
              </ion-item>

              <ion-item lines="none">
                <ion-input
                  label="Ciudad *"
                  label-placement="stacked"
                  placeholder="Lima"
                  [value]="manualCity()"
                  (ionInput)="onCityInput($any($event).target.value)"
                  required
                ></ion-input>
              </ion-item>

              <ion-item lines="none">
                <ion-input
                  label="Referencia (opcional)"
                  label-placement="stacked"
                  placeholder="Ayudanos a llegar facil: color de casa, edificio, etc."
                  [value]="addressReference()"
                  (ionInput)="onReferenceInput($any($event).target.value)"
                ></ion-input>
              </ion-item>
            </div>
          }

          <!-- Geocoding feedback (A2) -->
          @if (isGeocodingAddress()) {
            <div class="geocoding-feedback">
              <ion-spinner name="dots" color="primary"></ion-spinner>
              <span>Validando direccion...</span>
            </div>
          }
        </ion-card-content>
      </ion-card>

      <!-- Date & Time Section -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="calendar-outline"></ion-icon>
            Â¿Cuando te visitamos?
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p class="section-helper">La enfermera confirmara la hora exacta contigo antes de la visita.</p>
          <!-- Date Picker -->
          <ion-item lines="none" class="date-picker-item">
            <ion-label>Fecha deseada *</ion-label>
            <ion-datetime-button datetime="request-date"></ion-datetime-button>
            <ion-modal [keepContentsMounted]="true">
              <ng-template>
                <ion-datetime
                  id="request-date"
                  presentation="date"
                  [min]="getMinDate()"
                  [max]="getMaxDate()"
                  [value]="requestedDate()"
                  (ionChange)="onDateChange($event)"
                  locale="es-PE"
                  [firstDayOfWeek]="1"
                >
                  <span slot="title">Seleccionar fecha</span>
                </ion-datetime>
              </ng-template>
            </ion-modal>
          </ion-item>

          <!-- Time Slot Selection -->
          <div class="time-slot-section">
            <ion-label class="time-slot-label">Horario preferido *</ion-label>
            <div class="time-slot-grid">
              @for (slot of availableTimeSlots(); track slot.value) {
                <div
                  class="time-slot-option"
                  [class.selected]="requestedTimeSlot() === slot.value"
                  (click)="onTimeSlotChange(slot.value)"
                >
                  <ion-icon [name]="slot.icon"></ion-icon>
                  <span>{{ slot.label }}</span>
                </div>
              }
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Notes Section -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="document-text-outline"></ion-icon>
            Cuentanos mas (opcional)
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <ion-textarea
            placeholder="Alergias, medicamentos, movilidad reducida..."
            [value]="patientNotes()"
            (ionInput)="onNotesInput($any($event).target.value)"
            [autoGrow]="true"
            [rows]="3"
            [maxlength]="500"
          ></ion-textarea>
          <div class="char-counter">
            {{ patientNotes().length }}/500
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Attachments Section -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>
            <ion-icon name="attach-outline"></ion-icon>
            Adjuntar receta o documento (opcional)
          </ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p class="section-helper">Adjunta recetas medicas o documentos para que la enfermera pueda prepararse mejor.</p>

          @if (attachments().length < 3) {
            <ion-button
              fill="outline"
              expand="block"
              (click)="addAttachment()"
              [disabled]="isUploadingAttachment()"
              class="attachment-btn">
              @if (isUploadingAttachment()) {
                <ion-spinner name="dots" slot="start"></ion-spinner>
                Subiendo...
              } @else {
                <ion-icon name="camera-outline" slot="start"></ion-icon>
                Adjuntar foto o documento
              }
            </ion-button>
          }

          @if (attachments().length > 0) {
            <div class="attachments-list">
              @for (attachment of attachments(); track attachment.publicId; let i = $index) {
                <div class="attachment-item">
                  @if (attachment.type === 'image') {
                    <img [src]="attachment.url" [alt]="attachment.name" class="attachment-thumb" />
                  } @else {
                    <div class="attachment-pdf-icon">
                      <ion-icon name="document-outline"></ion-icon>
                    </div>
                  }
                  <span class="attachment-name">{{ attachment.name }}</span>
                  <ion-button fill="clear" size="small" color="danger" (click)="removeAttachment(i)">
                    <ion-icon name="close-circle" slot="icon-only"></ion-icon>
                  </ion-button>
                </div>
              }
            </div>
          }

          <p class="attachment-hint">Maximo 3 archivos (JPEG, PNG o PDF, 5MB c/u)</p>
        </ion-card-content>
      </ion-card>

      <!-- Summary Card -->
      @if (selectedService()) {
        <ion-card class="summary-card">
          <ion-card-header>
            <ion-card-title>
              <ion-icon name="receipt-outline"></ion-icon>
              Resumen del Servicio
            </ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-list lines="none">
              <ion-item>
                <ion-label>
                  <p>Servicio</p>
                  <h3>{{ selectedService()!.name }}</h3>
                </ion-label>
              </ion-item>
              <ion-item>
                <ion-label>
                  <p>Duracion estimada</p>
                  <h3>{{ formatDuration(selectedService()!.durationMinutes) }}</h3>
                </ion-label>
              </ion-item>
              <ion-item class="total-item">
                <ion-label>
                  <h3>Total a pagar</h3>
                </ion-label>
                <ion-note slot="end" class="total-price">
                  {{ formatPrice(selectedService()!.price, selectedService()!.currency) }}
                </ion-note>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>
      }
    </div>
  }
</ion-content>

<!-- Submit Button Footer -->
@if (nurse() && nurse()!.isAvailable && !isLoading() && !error()) {
  <ion-footer class="ion-no-border">
    <ion-toolbar>
      <ion-button
        expand="block"
        (click)="submitRequest()"
        [disabled]="!isFormValid() || isSubmitting()"
      >
        @if (isSubmitting()) {
          <ion-spinner name="crescent" slot="start"></ion-spinner>
          Enviando...
        } @else {
          <ion-icon name="checkmark-circle" slot="start"></ion-icon>
          Confirmar Solicitud
        }
      </ion-button>
    </ion-toolbar>
  </ion-footer>
}
