<ion-content class="tracking-content" [fullscreen]="true">
  <!-- Loading State -->
  @if (isLoading()) {
  <div class="loading-container">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Cargando información...</p>
  </div>
  }

  <!-- Error State (generic errors only) -->
  @if (!isLoading() && loadError() && !isRejected() && !isCancelled()) {
  <div class="error-container">
    <ion-icon name="alert-circle-outline" color="danger" class="error-icon"></ion-icon>
    <h3>Error</h3>
    <p>{{ loadError() }}</p>
    <ion-button expand="block" (click)="retryLoadRequest()">
      <ion-icon name="refresh-outline" slot="start"></ion-icon>
      Reintentar
    </ion-button>
    <ion-button expand="block" fill="outline" routerLink="/patient/history">
      <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
      Volver al historial
    </ion-button>
  </div>
  }

  <!-- Rejected State - Empathetic design -->
  @if (!isLoading() && isRejected()) {
  <div class="status-container rejected-container">
    <div class="status-icon-wrapper rejected">
      <ion-icon name="calendar-clear-outline"></ion-icon>
    </div>
    <h3>Este servicio no pudo completarse</h3>
    <p class="status-subtitle">La enfermera no estuvo disponible para atender tu solicitud</p>

    <!-- Service Details Card -->
    <div class="service-details-card">
      <h4>Detalles de la solicitud</h4>
      <div class="detail-row">
        <span class="detail-label">Servicio</span>
        <span class="detail-value">{{ request()?.service?.name }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Fecha solicitada</span>
        <span class="detail-value">{{ request()?.requestedDate | date:'dd/MM/yyyy HH:mm' }}</span>
      </div>
      @if (nurse()) {
      <div class="detail-row">
        <span class="detail-label">Enfermera</span>
        <span class="detail-value">{{ nurse()?.firstName }} {{ nurse()?.lastName }}</span>
      </div>
      }
    </div>

    <!-- Alternative Nurses Section -->
    @if (isLoadingAlternatives()) {
    <div class="alternatives-loading">
      <ion-spinner name="dots" color="primary"></ion-spinner>
      <span>Buscando enfermeras disponibles...</span>
    </div>
    } @else if (alternativeNurses().length > 0) {
    <div class="alternatives-section">
      <h4>Enfermeras disponibles cerca de ti</h4>
      <div class="alternatives-list">
        @for (altNurse of alternativeNurses(); track altNurse.id) {
        <div class="alternative-nurse-card" (click)="requestAlternativeNurse(altNurse.id)">
          <ion-avatar class="alt-nurse-avatar">
            @if (altNurse.avatar) {
            <img [src]="altNurse.avatar" alt="Enfermera">
            } @else {
            <ion-icon name="person-circle"></ion-icon>
            }
          </ion-avatar>
          <div class="alt-nurse-info">
            <span class="alt-nurse-name">{{ altNurse.firstName }} {{ altNurse.lastName }}</span>
            @if (altNurse.rating > 0) {
            <span class="alt-nurse-rating">
              <ion-icon name="star" color="warning"></ion-icon>
              {{ altNurse.rating.toFixed(1) }}
              <span class="rating-count">({{ altNurse.totalReviews }})</span>
            </span>
            } @else {
            <span class="alt-nurse-new">Nueva en NurseLite</span>
            }
          </div>
          <ion-icon name="chevron-forward" class="alt-nurse-arrow"></ion-icon>
        </div>
        }
      </div>
    </div>
    } @else {
    <!-- No alternatives - show generic next steps -->
    <div class="next-steps">
      <h4>¿Que puedes hacer ahora?</h4>
      <ul>
        <li>
          <ion-icon name="checkmark-circle" color="success"></ion-icon>
          <span>Buscar otra enfermera disponible en el mapa</span>
        </li>
        <li>
          <ion-icon name="checkmark-circle" color="success"></ion-icon>
          <span>Revisar otras fechas u horarios disponibles</span>
        </li>
      </ul>
    </div>
    }

    <!-- Actions -->
    <div class="status-actions">
      <ion-button expand="block" (click)="searchAnotherNurse()">
        <ion-icon name="search-outline" slot="start"></ion-icon>
        Buscar en el mapa
      </ion-button>
      <ion-button expand="block" fill="outline" routerLink="/patient/history">
        <ion-icon name="list-outline" slot="start"></ion-icon>
        Ver historial
      </ion-button>
    </div>
  </div>
  }

  <!-- Cancelled State -->
  @if (!isLoading() && isCancelled()) {
  <div class="status-container cancelled-container">
    <div class="status-icon-wrapper cancelled">
      <ion-icon name="close-circle-outline"></ion-icon>
    </div>
    <h3>Servicio cancelado</h3>
    <p class="status-subtitle">Este servicio fue cancelado</p>

    <!-- Service Details Card -->
    <div class="service-details-card">
      <h4>Detalles de la solicitud</h4>
      <div class="detail-row">
        <span class="detail-label">Servicio</span>
        <span class="detail-value">{{ request()?.service?.name }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Fecha</span>
        <span class="detail-value">{{ request()?.requestedDate | date:'dd/MM/yyyy HH:mm' }}</span>
      </div>
    </div>

    <!-- Actions -->
    <div class="status-actions">
      <ion-button expand="block" (click)="searchAnotherNurse()">
        <ion-icon name="search-outline" slot="start"></ion-icon>
        Solicitar nuevo servicio
      </ion-button>
      <ion-button expand="block" fill="outline" routerLink="/patient/history">
        <ion-icon name="list-outline" slot="start"></ion-icon>
        Ver historial
      </ion-button>
    </div>
  </div>
  }

  <!-- Waiting for Confirmation State (pending) -->
  @if (!isLoading() && !loadError() && currentStatus() === 'pending') {
  <div class="waiting-container">
    <div class="waiting-animation">
      <ion-spinner name="dots" color="primary"></ion-spinner>
    </div>
    <h3>Esperando confirmacion</h3>
    <p class="waiting-subtitle">Tu solicitud ha sido enviada a {{ nurse()?.firstName }}</p>

    <!-- Nurse Mini Card -->
    <div class="waiting-nurse-card">
      <ion-avatar class="waiting-nurse-avatar">
        @if (nurse()?.avatar) {
        <img [src]="nurse()?.avatar" alt="Enfermera">
        } @else {
        <ion-icon name="person-circle"></ion-icon>
        }
      </ion-avatar>
      <div class="waiting-nurse-info">
        <span class="nurse-name">{{ nurse()?.firstName }} {{ nurse()?.lastName }}</span>
        @if (nurse()?.rating && nurse()!.rating > 0) {
        <span class="nurse-rating">
          <ion-icon name="star" color="warning"></ion-icon>
          {{ nurse()?.rating?.toFixed(1) }}
        </span>
        }
      </div>
    </div>

    <!-- Service Summary -->
    <div class="waiting-service-card">
      <div class="service-row">
        <ion-icon name="medkit-outline"></ion-icon>
        <span>{{ request()?.service?.name }}</span>
      </div>
      <div class="service-row">
        <ion-icon name="calendar-outline"></ion-icon>
        <span>{{ request()?.requestedDate | date:'EEEE, d MMMM':'':'es' }}</span>
      </div>
      <div class="service-row">
        <ion-icon name="time-outline"></ion-icon>
        <span>{{ getTimeSlotLabel(request()?.requestedTimeSlot) }}</span>
      </div>
    </div>

    <!-- Info Message -->
    <div class="waiting-info">
      <ion-icon name="information-circle-outline"></ion-icon>
      <span>Recibirás una notificación cuando la enfermera confirme tu solicitud.</span>
    </div>

    <!-- Actions -->
    <div class="waiting-actions">
      <ion-button expand="block" fill="outline" (click)="cancelRequest()">
        <ion-icon name="close-circle-outline" slot="start"></ion-icon>
        Cancelar solicitud
      </ion-button>
    </div>
  </div>
  }

  @if (!isLoading() && !loadError() && currentStatus() !== 'pending') {
  <!-- Map Container -->
  <div id="tracking-map" class="map-container"></div>

  <!-- Map Controls -->
  <div class="map-controls" role="navigation" aria-label="Navegación">
    <ion-button fill="clear" class="control-btn" (click)="goBack()" aria-label="Volver atrás">
      <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
    </ion-button>
  </div>

  <div class="map-controls-right" role="group" aria-label="Controles del mapa">
    <ion-button fill="clear" class="control-btn" (click)="centerOnPatient()" aria-label="Centrar en mi ubicación">
      <ion-icon name="locate" slot="icon-only"></ion-icon>
    </ion-button>
    <ion-button fill="clear" class="control-btn" (click)="showFullRoute()" aria-label="Ver ruta completa">
      <ion-icon name="expand" slot="icon-only"></ion-icon>
    </ion-button>
  </div>

  <!-- ETA Badge -->
  @if (eta()) {
  <div class="eta-badge">
    <ion-icon name="time-outline"></ion-icon>
    <span class="eta-time">{{ formattedEta() }}</span>
    <span class="eta-label">llegada</span>
  </div>
  }

  <!-- Bottom Sheet -->
  <div class="bottom-sheet">
    <!-- Status Progress -->
    <div class="status-progress" #statusProgressContainer>
      <div class="progress-track">
        @for (step of statusSteps; track step.key; let i = $index) {
        <div class="progress-step"
             [id]="'step-' + step.key"
             [class.completed]="isStepCompleted(step.key)"
             [class.active]="isStepActive(step.key)">
          <div class="step-dot">
            @if (isStepCompleted(step.key)) {
            <ion-icon name="checkmark"></ion-icon>
            } @else {
            <ion-icon [name]="step.icon"></ion-icon>
            }
          </div>
          <span class="step-label">{{ step.label }}</span>
        </div>
        @if (i < statusSteps.length - 1) {
        <div class="progress-line"
             [class.completed]="isStepCompleted(statusSteps[i + 1].key)"></div>
        }
        }
      </div>
    </div>

    <!-- Nurse Info Card -->
    <div class="nurse-card">
      <div class="nurse-info">
        <ion-avatar class="nurse-avatar">
          @if (nurse()?.avatar) {
          <img [src]="nurse()?.avatar" alt="Enfermera">
          } @else {
          <ion-icon name="person-circle" class="avatar-placeholder"></ion-icon>
          }
        </ion-avatar>
        <div class="nurse-details">
          <h3>{{ nurse()?.firstName }} {{ nurse()?.lastName }}</h3>
          <div class="nurse-meta">
            @if (nurse()?.rating && nurse()!.rating > 0) {
            <span class="rating">
              <ion-icon name="star" color="warning"></ion-icon>
              {{ nurse()?.rating?.toFixed(1) }}
            </span>
            <span class="reviews">({{ nurse()?.totalReviews || 0 }} reseñas)</span>
            } @else {
            <span class="new-nurse">Enfermera verificada</span>
            }
          </div>
        </div>
        <div class="nurse-actions" role="group" aria-label="Acciones de contacto">
          <ion-button fill="clear" class="action-btn" (click)="callNurse()" aria-label="Llamar a la enfermera">
            <ion-icon name="call" slot="icon-only" color="success"></ion-icon>
          </ion-button>
          <div class="chat-btn-wrapper">
            <ion-button fill="clear" class="action-btn chat-btn" (click)="openChat()" aria-label="Abrir chat con la enfermera">
              <div class="chat-pulse"></div>
              <ion-icon name="chatbubble" slot="icon-only" color="primary"></ion-icon>
              @if (chatUnreadCount() > 0) {
                <ion-badge color="danger" class="chat-badge">{{ chatUnreadCount() }}</ion-badge>
              }
            </ion-button>
            <div class="chat-tooltip">Comunicate con tu enfermera</div>
          </div>
        </div>
      </div>

      <!-- Service Info -->
      <div class="service-info">
        <div class="service-name">
          <ion-icon name="medkit-outline" color="primary"></ion-icon>
          <span>{{ request()?.service?.name }}</span>
        </div>
        <div class="service-price">
          S/ {{ request()?.service?.price }}
        </div>
      </div>

      <!-- Route Info -->
      <div class="route-info">
        <div class="info-item">
          <ion-icon name="navigate-outline"></ion-icon>
          <div class="info-content">
            <span class="info-value">{{ formattedDistance() }}</span>
            <span class="info-label">distancia</span>
          </div>
        </div>
        <div class="info-divider"></div>
        <div class="info-item">
          <ion-icon name="time-outline"></ion-icon>
          <div class="info-content">
            <span class="info-value">{{ formattedDuration() }}</span>
            <span class="info-label">tiempo est.</span>
          </div>
        </div>
        <div class="info-divider"></div>
        <div class="info-item">
          <ion-icon name="location-outline"></ion-icon>
          <div class="info-content">
            <span class="info-value address">{{ request()?.location?.district }}</span>
            <span class="info-label">destino</span>
          </div>
        </div>
      </div>

      <!-- Status Message - Empathetic microcopy with nurse name -->
      <div class="status-message" [ngClass]="'status-' + currentStatus()" role="status" aria-live="polite">
        @switch (currentStatus()) {
        @case ('accepted') {
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>{{ nurse()?.firstName || 'La enfermera' }} acepto tu solicitud con gusto.</span>
        }
        @case ('on_the_way') {
        <ion-icon name="navigate"></ion-icon>
        <span>{{ nurse()?.firstName || 'La enfermera' }} esta en camino. Tranquilo(a), ya casi llega.</span>
        }
        @case ('arrived') {
        <ion-icon name="location"></ion-icon>
        <span>¡{{ nurse()?.firstName || 'La enfermera' }} llego! Revisa que sea ella antes de abrir.</span>
        }
        @case ('in_progress') {
        <ion-icon name="medical"></ion-icon>
        <span>{{ nurse()?.firstName || 'La enfermera' }} te esta atendiendo. Estas en buenas manos.</span>
        }
        @case ('completed') {
        <ion-icon name="checkmark-done"></ion-icon>
        <span>¡Listo! Esperamos que {{ nurse()?.firstName || 'la enfermera' }} haya cumplido tus expectativas.</span>
        }
        }
      </div>

      <!-- Contextual Tip - Proactive helpful message (only show after nurse accepts) -->
      @if (currentStatus() !== 'pending') {
      <div class="contextual-tip" role="note">
        @switch (currentStatus()) {
        @case ('accepted') {
        <ion-icon name="time-outline"></ion-icon>
        <span>Estara lista pronto. Ten a la mano tu DNI y cualquier documento medico relevante.</span>
        }
        @case ('on_the_way') {
        <ion-icon name="bulb-outline"></ion-icon>
        <span>Puedes ir preparando un espacio comodo y bien iluminado para la atencion.</span>
        }
        @case ('arrived') {
        <ion-icon name="shield-checkmark-outline"></ion-icon>
        <span>Por tu seguridad, confirma su identidad (foto y nombre) antes de permitir el ingreso.</span>
        }
        @case ('in_progress') {
        <ion-icon name="bulb-outline"></ion-icon>
        <span>Si tienes preguntas sobre el procedimiento, no dudes en preguntarle.</span>
        }
        @case ('completed') {
        <ion-icon name="heart-outline"></ion-icon>
        <span>Tu opinion nos ayuda a mejorar. ¡Gracias por confiar en NurseLite!</span>
        }
        }
      </div>
      }

      <!-- Cancel Button (only if not started) -->
      @if (currentStatus() === 'accepted' || currentStatus() === 'on_the_way') {
      <div class="cancel-section">
        <ion-button fill="clear" color="danger" expand="block" (click)="cancelRequest()">
          <ion-icon name="close-circle-outline" slot="start"></ion-icon>
          Cancelar servicio
        </ion-button>
      </div>
      }

      <!-- Payment Section (P2P) -->
      @if (currentStatus() === 'completed' && hasPaymentMethods()) {
      <div class="payment-section">
        <div class="payment-header">
          <ion-icon name="wallet-outline"></ion-icon>
          <div class="payment-title">
            <h4>Pagar a la enfermera</h4>
            <p>Selecciona un metodo de pago</p>
          </div>
        </div>

        <div class="payment-methods">
          <!-- Yape -->
          @if (nurse()?.yapeNumber) {
          <div class="payment-method" (click)="copyPaymentNumber(nurse()!.yapeNumber!, 'yape')">
            <div class="payment-logo yape">
              <img src="assets/img/logo-yape.png" alt="Yape" />
            </div>
            <div class="payment-info">
              <span class="payment-label">Yape</span>
              <span class="payment-number">{{ nurse()?.yapeNumber }}</span>
            </div>
            <ion-icon [name]="copiedPayment() === 'yape' ? 'checkmark-circle' : 'copy-outline'"
                      [color]="copiedPayment() === 'yape' ? 'success' : 'medium'"></ion-icon>
          </div>
          }

          <!-- Plin -->
          @if (nurse()?.plinNumber) {
          <div class="payment-method" (click)="copyPaymentNumber(nurse()!.plinNumber!, 'plin')">
            <div class="payment-logo plin">
              <img src="assets/img/logo-plin.png" alt="Plin" />
            </div>
            <div class="payment-info">
              <span class="payment-label">Plin</span>
              <span class="payment-number">{{ nurse()?.plinNumber }}</span>
            </div>
            <ion-icon [name]="copiedPayment() === 'plin' ? 'checkmark-circle' : 'copy-outline'"
                      [color]="copiedPayment() === 'plin' ? 'success' : 'medium'"></ion-icon>
          </div>
          }

          <!-- Cash -->
          @if (nurse()?.acceptsCash) {
          <div class="payment-method cash">
            <div class="payment-logo cash-logo">
              <ion-icon name="cash-outline"></ion-icon>
            </div>
            <div class="payment-info">
              <span class="payment-label">Efectivo</span>
              <span class="payment-hint">Paga directamente a la enfermera</span>
            </div>
            <ion-icon name="checkmark-circle" color="success"></ion-icon>
          </div>
          }
        </div>

        <div class="payment-amount">
          <span class="amount-label">Monto a pagar:</span>
          <span class="amount-value">S/ {{ request()?.service?.price }}</span>
        </div>
      </div>
      }

      <!-- Completed Actions -->
      @if (currentStatus() === 'completed') {
      <div class="completed-actions">
        @if (shouldShowReview()) {
        <ion-button expand="block" color="primary" (click)="openReviewModal()">
          <ion-icon name="star-outline" slot="start"></ion-icon>
          Calificar servicio
        </ion-button>
        } @else if (hasReviewed()) {
        <div class="review-submitted">
          <ion-icon name="checkmark-circle" color="success"></ion-icon>
          <span>Gracias por tu calificación</span>
        </div>
        }
        <ion-button expand="block" fill="outline" routerLink="/patient/history">
          <ion-icon name="list-outline" slot="start"></ion-icon>
          Ver historial
        </ion-button>
      </div>
      }
    </div>
  </div>
  }
</ion-content>
