<ion-content class="register-content" [fullscreen]="true">
  <div class="register-container">
    <!-- Back Button -->
    <ion-button fill="clear" class="back-btn" (click)="goBack()">
      <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
    </ion-button>

    <!-- User Type Selection (shown when no type is selected) -->
    <div class="type-selection-section" *ngIf="!selectedUserType">
      <div class="type-selection-header">
        <div class="logo-wrapper">
          <img src="assets/icon/nurselite.png" alt="NurseLite" class="logo-image">
        </div>
        <h2 class="type-selection-title">¿Cómo deseas registrarte?</h2>
        <p class="type-selection-subtitle">Selecciona una opción para continuar</p>
      </div>

      <div class="type-cards">
        <!-- Patient Card -->
        <div class="type-card patient-card" (click)="selectUserType('patient')">
          <div class="type-card-icon">
            <ion-icon name="search"></ion-icon>
          </div>
          <h3 class="type-card-title">Busco Enfermera</h3>
          <p class="type-card-description">
            Necesito atención de enfermería a domicilio para mí o un familiar
          </p>
          <div class="type-card-features">
            <span><ion-icon name="checkmark-circle"></ion-icon> Sin suscripciones</span>
            <span><ion-icon name="checkmark-circle"></ion-icon> Enfermeras verificadas</span>
          </div>
        </div>

        <!-- Nurse Card -->
        <div class="type-card nurse-card" (click)="selectUserType('nurse')">
          <div class="type-card-icon">
            <ion-icon name="medical"></ion-icon>
          </div>
          <h3 class="type-card-title">Soy Enfermera/o</h3>
          <p class="type-card-description">
            Quiero ofrecer mis servicios profesionales de enfermería
          </p>
          <div class="type-card-features">
            <span><ion-icon name="checkmark-circle"></ion-icon> Define tu tarifa</span>
            <span><ion-icon name="checkmark-circle"></ion-icon> Horarios flexibles</span>
          </div>
        </div>
      </div>

      <div class="type-selection-footer">
        <p>¿Ya tienes una cuenta?</p>
        <ion-button fill="clear" class="login-link" routerLink="/auth/login">
          Iniciar Sesión
        </ion-button>
      </div>
    </div>

    <!-- Registration Form -->
    <div class="form-section" *ngIf="selectedUserType">
      <h2 class="form-title">
        {{ selectedUserType === 'nurse' ? 'Registro de Enfermera/o' : 'Registro de Paciente' }}
      </h2>

      <form [formGroup]="registerForm" (ngSubmit)="onSubmit()">
        <!-- Name Fields -->
        <div class="name-row">
          <ion-item lines="none" class="input-item" [class.input-error]="firstName?.invalid && firstName?.touched">
            <ion-input
              formControlName="firstName"
              placeholder="Nombre"
              autocomplete="given-name">
            </ion-input>
          </ion-item>
          <ion-item lines="none" class="input-item" [class.input-error]="lastName?.invalid && lastName?.touched">
            <ion-input
              formControlName="lastName"
              placeholder="Apellido"
              autocomplete="family-name">
            </ion-input>
          </ion-item>
        </div>
        <div class="error-message" *ngIf="(firstName?.invalid && firstName?.touched) || (lastName?.invalid && lastName?.touched)">
          <span *ngIf="firstName?.errors?.['required'] || lastName?.errors?.['required']">Nombre y apellido son requeridos</span>
        </div>

        <!-- Email -->
        <ion-item lines="none" class="input-item" [class.input-error]="email?.invalid && email?.touched">
          <ion-icon name="mail-outline" slot="start" class="input-icon"></ion-icon>
          <ion-input
            type="email"
            formControlName="email"
            placeholder="Correo electrónico"
            autocomplete="email"
            inputmode="email">
          </ion-input>
        </ion-item>
        <div class="error-message" *ngIf="email?.invalid && email?.touched">
          <span *ngIf="email?.errors?.['required']">El correo es requerido</span>
          <span *ngIf="email?.errors?.['email']">Ingresa un correo válido</span>
        </div>

        <!-- Phone -->
        <ion-item lines="none" class="input-item" [class.input-error]="phone?.invalid && phone?.touched">
          <ion-icon name="call-outline" slot="start" class="input-icon"></ion-icon>
          <ion-input
            type="tel"
            formControlName="phone"
            placeholder="Teléfono (9 dígitos)"
            autocomplete="tel"
            inputmode="tel"
            maxlength="9">
          </ion-input>
        </ion-item>
        <div class="error-message" *ngIf="phone?.invalid && phone?.touched">
          <span *ngIf="phone?.errors?.['required']">El teléfono es requerido</span>
          <span *ngIf="phone?.errors?.['pattern']">Ingresa 9 dígitos</span>
        </div>

        <!-- CEP Number (Nurses only) -->
        <ng-container *ngIf="selectedUserType === 'nurse'">
          <ion-item lines="none" class="input-item" [class.input-error]="cepNumber?.invalid && cepNumber?.touched">
            <ion-icon name="card-outline" slot="start" class="input-icon"></ion-icon>
            <ion-input
              formControlName="cepNumber"
              placeholder="Número CEP (6 dígitos)"
              inputmode="numeric"
              maxlength="6">
            </ion-input>
          </ion-item>
          <div class="error-message" *ngIf="cepNumber?.invalid && cepNumber?.touched">
            <span *ngIf="cepNumber?.errors?.['required']">El número CEP es requerido</span>
            <span *ngIf="cepNumber?.errors?.['pattern']">Ingresa 6 dígitos</span>
          </div>

          <!-- Specialties -->
          <ion-item lines="none" class="input-item select-item">
            <ion-icon name="list-outline" slot="start" class="input-icon"></ion-icon>
            <ion-select
              formControlName="specialties"
              placeholder="Especialidades (opcional)"
              [multiple]="true"
              interface="alert">
              <ion-select-option *ngFor="let specialty of specialtiesOptions" [value]="specialty">
                {{ specialty }}
              </ion-select-option>
            </ion-select>
          </ion-item>
        </ng-container>

        <!-- Password -->
        <ion-item lines="none" class="input-item" [class.input-error]="password?.invalid && password?.touched">
          <ion-icon name="lock-closed-outline" slot="start" class="input-icon"></ion-icon>
          <ion-input
            [type]="showPassword ? 'text' : 'password'"
            formControlName="password"
            placeholder="Contraseña"
            autocomplete="new-password">
          </ion-input>
          <ion-button fill="clear" slot="end" (click)="togglePassword()" class="password-toggle">
            <ion-icon [name]="showPassword ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
          </ion-button>
        </ion-item>
        <div class="error-message" *ngIf="password?.invalid && password?.touched">
          <span *ngIf="password?.errors?.['required']">La contraseña es requerida</span>
          <span *ngIf="password?.errors?.['minlength']">Mínimo 8 caracteres</span>
        </div>

        <!-- Confirm Password -->
        <ion-item lines="none" class="input-item" [class.input-error]="confirmPassword?.invalid && confirmPassword?.touched">
          <ion-icon name="lock-closed-outline" slot="start" class="input-icon"></ion-icon>
          <ion-input
            [type]="showConfirmPassword ? 'text' : 'password'"
            formControlName="confirmPassword"
            placeholder="Confirmar contraseña"
            autocomplete="new-password">
          </ion-input>
          <ion-button fill="clear" slot="end" (click)="toggleConfirmPassword()" class="password-toggle">
            <ion-icon [name]="showConfirmPassword ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
          </ion-button>
        </ion-item>
        <div class="error-message" *ngIf="confirmPassword?.invalid && confirmPassword?.touched">
          <span *ngIf="confirmPassword?.errors?.['required']">Confirma tu contraseña</span>
          <span *ngIf="confirmPassword?.errors?.['mismatch']">Las contraseñas no coinciden</span>
        </div>

        <!-- Terms -->
        <div class="terms-section">
          <ion-checkbox formControlName="acceptTerms" labelPlacement="end">
            <span class="terms-text">
              Acepto los <a href="#">Términos y Condiciones</a> y la <a href="#">Política de Privacidad</a>
            </span>
          </ion-checkbox>
        </div>
        <div class="error-message" *ngIf="acceptTerms?.invalid && acceptTerms?.touched">
          <span>Debes aceptar los términos y condiciones</span>
        </div>

        <!-- Professional Disclaimer (Nurses only) -->
        <ng-container *ngIf="selectedUserType === 'nurse'">
          <div class="terms-section professional-disclaimer">
            <ion-checkbox formControlName="acceptProfessionalDisclaimer" labelPlacement="end">
              <span class="terms-text">
                Declaro que soy profesional de enfermería colegiado y que mi número CEP está vigente.
                Entiendo que mis credenciales serán verificadas antes de poder ofrecer servicios.
              </span>
            </ion-checkbox>
          </div>
          <div class="error-message" *ngIf="acceptProfessionalDisclaimer?.invalid && acceptProfessionalDisclaimer?.touched">
            <span>Debes aceptar la declaración profesional</span>
          </div>
        </ng-container>

        <!-- Register Button -->
        <ion-button
          expand="block"
          type="submit"
          class="register-btn"
          [disabled]="registerForm.invalid || isSubmitting()">
          <ion-icon name="person-add-outline" slot="start"></ion-icon>
          {{ isSubmitting() ? 'Creando cuenta...' : 'Crear Cuenta' }}
        </ion-button>
      </form>
    </div>
  </div>
</ion-content>

<!-- CEP Validation Loading Overlay -->
<div class="cep-loading-overlay" *ngIf="showCepLoading()">
  <div class="cep-loading-card">
    <div class="cep-logo-container">
      <img src="assets/icon/cep-logo.png" alt="CEP" class="cep-logo" onerror="this.style.display='none'">
      <div class="cep-logo-pulse"></div>
    </div>

    <h3 class="cep-loading-title">Validando tu colegiatura</h3>

    <div class="cep-progress-bar">
      <div class="cep-progress-fill"></div>
    </div>

    <p class="cep-loading-message">{{ cepLoadingMessage() }}</p>
    <p class="cep-loading-subtext">{{ cepLoadingSubtext() }}</p>

    <p class="cep-loading-time">
      <ion-icon name="time-outline"></ion-icon>
      Este proceso puede tomar 5-10 segundos
    </p>
  </div>
</div>

<!-- Success Transition Screen -->
<div class="success-transition-overlay" *ngIf="showSuccessTransition()">
  <div class="success-transition-card">
    <div class="success-icon-container">
      <ion-icon name="checkmark-circle" class="success-icon"></ion-icon>
    </div>

    <h2 class="success-title">¡Perfecto, {{ registeredUserName() }}!</h2>
    <p class="success-subtitle">Tu cuenta ha sido creada exitosamente</p>

    <div class="progress-checklist">
      <div class="checklist-item completed">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>Datos personales</span>
      </div>
      <div class="checklist-item completed">
        <ion-icon name="checkmark-circle"></ion-icon>
        <span>CEP verificado</span>
      </div>
      <div class="checklist-item pending">
        <ion-icon name="ellipse-outline"></ion-icon>
        <span>Verificación de identidad</span>
      </div>
      <div class="checklist-item pending">
        <ion-icon name="ellipse-outline"></ion-icon>
        <span>Aprobación final</span>
      </div>
    </div>

    <div class="next-step-info">
      <ion-icon name="camera-outline" class="next-step-icon"></ion-icon>
      <div class="next-step-text">
        <h4>Siguiente paso: Verifica tu identidad</h4>
        <p>Sube tu DNI y tómale una selfie para confirmar que eres tú</p>
      </div>
    </div>

    <p class="time-estimate">
      <ion-icon name="time-outline"></ion-icon>
      Solo toma 2 minutos
    </p>

    <ion-button expand="block" class="continue-btn" (click)="continueToVerification()">
      <ion-icon name="arrow-forward" slot="end"></ion-icon>
      Continuar
    </ion-button>

    <ion-button fill="clear" class="skip-btn" (click)="skipVerificationForNow()">
      Lo haré después
    </ion-button>
  </div>
</div>
