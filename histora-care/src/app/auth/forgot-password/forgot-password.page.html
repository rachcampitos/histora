<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" aria-label="Volver">
        <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Recuperar Contrasena</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="forgot-password-container">
    <!-- Step indicator -->
    <div class="step-indicator">
      <div class="step" [class.active]="currentStep === 'email'" [class.completed]="currentStep !== 'email'">
        <div class="step-number">1</div>
        <span>Email</span>
      </div>
      <div class="step-line" [class.active]="currentStep !== 'email'"></div>
      <div class="step" [class.active]="currentStep === 'otp'" [class.completed]="currentStep === 'password'">
        <div class="step-number">2</div>
        <span>Codigo</span>
      </div>
      <div class="step-line" [class.active]="currentStep === 'password'"></div>
      <div class="step" [class.active]="currentStep === 'password'">
        <div class="step-number">3</div>
        <span>Nueva</span>
      </div>
    </div>

    <!-- Step 1: Email -->
    @if (currentStep === 'email') {
      <div class="step-content">
        <div class="step-header">
          <ion-icon name="mail-outline" class="header-icon"></ion-icon>
          <h2>Ingresa tu correo</h2>
          <p>Te enviaremos un codigo de 6 digitos para verificar tu identidad</p>
        </div>
        <form [formGroup]="emailForm" (ngSubmit)="requestOtp()">
          <ion-item lines="none" class="form-item" [class.ion-invalid]="emailCtrl?.invalid && emailCtrl?.touched">
            <ion-icon name="mail-outline" slot="start"></ion-icon>
            <ion-input
              type="email"
              formControlName="email"
              placeholder="correo@ejemplo.com"
              autocomplete="email"
            ></ion-input>
          </ion-item>
          @if (emailCtrl?.invalid && emailCtrl?.touched) {
            <div class="error-message">
              @if (emailCtrl?.errors?.['required']) {
                <span>El correo es requerido</span>
              }
              @if (emailCtrl?.errors?.['email']) {
                <span>Ingresa un correo valido</span>
              }
            </div>
          }
          <ion-button
            type="submit"
            expand="block"
            class="submit-button"
            [disabled]="emailForm.invalid"
            >
            Enviar Codigo
            <ion-icon slot="end" name="send-outline"></ion-icon>
          </ion-button>
        </form>
      </div>
    }

    <!-- Step 2: OTP Verification -->
    @if (currentStep === 'otp') {
      <div class="step-content">
        <div class="step-header">
          <ion-icon name="keypad-outline" class="header-icon"></ion-icon>
          <h2>Ingresa el codigo</h2>
          <p>Enviamos un codigo de 6 digitos a <strong>{{ email }}</strong></p>
        </div>
        <div class="otp-container" (paste)="onOtpPaste($event)">
          @for (digit of otp; track digit; let i = $index) {
            <input
              [id]="'otp-' + i"
              type="text"
              inputmode="numeric"
              maxlength="1"
              class="otp-input"
              [value]="otp[i]"
              (input)="onOtpInput($event, i)"
              (keydown)="onOtpKeydown($event, i)"
              autocomplete="one-time-code"
              />
          }
        </div>
        <div class="resend-section">
          @if (!canResendOtp) {
            <p>
              Reenviar codigo en <strong>{{ resendCountdown }}s</strong>
            </p>
          }
          @if (canResendOtp) {
            <ion-button
              fill="clear"
              (click)="resendOtp()"
              class="resend-button"
              >
              Reenviar codigo
              <ion-icon slot="end" name="refresh-outline"></ion-icon>
            </ion-button>
          }
        </div>
        <ion-button
          expand="block"
          class="submit-button"
          [disabled]="!isOtpComplete()"
          (click)="verifyOtp()"
          >
          Verificar
          <ion-icon slot="end" name="checkmark-circle-outline"></ion-icon>
        </ion-button>
      </div>
    }

    <!-- Step 3: New Password -->
    @if (currentStep === 'password') {
      <div class="step-content">
        <div class="step-header">
          <ion-icon name="lock-closed-outline" class="header-icon"></ion-icon>
          <h2>Nueva contrasena</h2>
          <p>Ingresa tu nueva contrasena</p>
        </div>
        <form [formGroup]="passwordForm" (ngSubmit)="resetPassword()">
          <ion-item lines="none" class="form-item" [class.ion-invalid]="passwordCtrl?.invalid && passwordCtrl?.touched">
            <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
            <ion-input
              [type]="showPassword ? 'text' : 'password'"
              formControlName="password"
              placeholder="Nueva contrasena"
              autocomplete="new-password"
            ></ion-input>
            <ion-button fill="clear" slot="end" (click)="togglePassword()" class="eye-button" [attr.aria-label]="showPassword ? 'Ocultar contrasena' : 'Mostrar contrasena'">
              <ion-icon [name]="showPassword ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
            </ion-button>
          </ion-item>
          @if (passwordCtrl?.invalid && passwordCtrl?.touched) {
            <div class="error-message">
              @if (passwordCtrl?.errors?.['required']) {
                <span>La contrasena es requerida</span>
              }
              @if (passwordCtrl?.errors?.['minlength']) {
                <span>Minimo 8 caracteres</span>
              }
            </div>
          }
          <ion-item lines="none" class="form-item" [class.ion-invalid]="confirmPasswordCtrl?.invalid && confirmPasswordCtrl?.touched">
            <ion-icon name="lock-closed-outline" slot="start"></ion-icon>
            <ion-input
              [type]="showConfirmPassword ? 'text' : 'password'"
              formControlName="confirmPassword"
              placeholder="Confirmar contrasena"
              autocomplete="new-password"
            ></ion-input>
            <ion-button fill="clear" slot="end" (click)="toggleConfirmPassword()" class="eye-button" [attr.aria-label]="showConfirmPassword ? 'Ocultar contrasena' : 'Mostrar contrasena'">
              <ion-icon [name]="showConfirmPassword ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
            </ion-button>
          </ion-item>
          @if (confirmPasswordCtrl?.touched && passwordForm.errors?.['mismatch']) {
            <div class="error-message">
              <span>Las contrasenas no coinciden</span>
            </div>
          }
          <ion-button
            type="submit"
            expand="block"
            class="submit-button"
            [disabled]="passwordForm.invalid"
            >
            Cambiar Contrasena
            <ion-icon slot="end" name="checkmark-done-outline"></ion-icon>
          </ion-button>
        </form>
      </div>
    }
  </div>
</ion-content>
