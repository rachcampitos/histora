<ion-content class="reset-content" [fullscreen]="true">
  <div class="reset-container">
    <!-- Logo and Brand -->
    <header class="brand-section" role="banner">
      <div class="logo-wrapper" aria-hidden="true">
        <img src="assets/icon/nurselite.png" alt="NurseLite" class="logo-image">
      </div>
      <h1 class="app-name">NurseLite</h1>
    </header>

    <!-- Invalid Token State -->
    <main class="form-section" role="main" *ngIf="!isValidToken">
      <div class="status-card error">
        <ion-icon name="alert-circle" class="status-icon"></ion-icon>
        <h2>Enlace Invalido</h2>
        <p>El enlace de recuperación es invalido o ha expirado. Por favor solicita uno nuevo.</p>
        <ion-button expand="block" (click)="goToLogin()">
          <ion-icon name="arrow-back" slot="start"></ion-icon>
          Volver al Login
        </ion-button>
      </div>
    </main>

    <!-- Success State -->
    <main class="form-section" role="main" *ngIf="isSuccess">
      <div class="status-card success">
        <ion-icon name="checkmark-circle" class="status-icon"></ion-icon>
        <h2>Contraseña Actualizada</h2>
        <p>Tu contraseña ha sido actualizada exitosamente. Ya puedes iniciar sesión con tu nueva contraseña.</p>
        <ion-button expand="block" (click)="goToLogin()">
          <ion-icon name="log-in-outline" slot="start"></ion-icon>
          Iniciar Sesion
        </ion-button>
      </div>
    </main>

    <!-- Reset Form -->
    <main class="form-section" role="main" *ngIf="isValidToken && !isSuccess">
      <h2 class="form-title">Restablecer Contraseña</h2>
      <p class="form-subtitle">Ingresa tu nueva contraseña</p>

      <form [formGroup]="resetForm" (ngSubmit)="onSubmit()" aria-label="Formulario de restablecimiento de contraseña">
        <!-- New Password Field -->
        <ion-item lines="none" class="input-item" [class.input-error]="password?.invalid && password?.touched">
          <ion-icon name="lock-closed-outline" slot="start" class="input-icon" aria-hidden="true"></ion-icon>
          <ion-input
            [type]="showPassword ? 'text' : 'password'"
            formControlName="password"
            placeholder="Nueva contraseña"
            autocomplete="new-password"
            aria-label="Nueva contraseña"
            [attr.aria-invalid]="password?.invalid && password?.touched">
          </ion-input>
          <ion-button
            fill="clear"
            slot="end"
            (click)="togglePassword()"
            class="password-toggle"
            type="button"
            [attr.aria-label]="showPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'">
            <ion-icon [name]="showPassword ? 'eye-off-outline' : 'eye-outline'" aria-hidden="true"></ion-icon>
          </ion-button>
        </ion-item>
        <div class="error-message" role="alert" *ngIf="password?.invalid && password?.touched">
          <span *ngIf="password?.errors?.['required']">La contraseña es requerida</span>
          <span *ngIf="password?.errors?.['minlength']">Minimo 8 caracteres</span>
        </div>

        <!-- Confirm Password Field -->
        <ion-item lines="none" class="input-item" [class.input-error]="confirmPassword?.invalid && confirmPassword?.touched || (resetForm.errors?.['passwordMismatch'] && confirmPassword?.touched)">
          <ion-icon name="lock-closed-outline" slot="start" class="input-icon" aria-hidden="true"></ion-icon>
          <ion-input
            [type]="showConfirmPassword ? 'text' : 'password'"
            formControlName="confirmPassword"
            placeholder="Confirmar contraseña"
            autocomplete="new-password"
            aria-label="Confirmar contraseña"
            [attr.aria-invalid]="confirmPassword?.invalid && confirmPassword?.touched">
          </ion-input>
          <ion-button
            fill="clear"
            slot="end"
            (click)="toggleConfirmPassword()"
            class="password-toggle"
            type="button"
            [attr.aria-label]="showConfirmPassword ? 'Ocultar contraseña' : 'Mostrar contraseña'">
            <ion-icon [name]="showConfirmPassword ? 'eye-off-outline' : 'eye-outline'" aria-hidden="true"></ion-icon>
          </ion-button>
        </ion-item>
        <div class="error-message" role="alert" *ngIf="confirmPassword?.invalid && confirmPassword?.touched || (resetForm.errors?.['passwordMismatch'] && confirmPassword?.touched)">
          <span *ngIf="confirmPassword?.errors?.['required']">Confirma tu contraseña</span>
          <span *ngIf="resetForm.errors?.['passwordMismatch'] && !confirmPassword?.errors?.['required']">Las contraseñas no coinciden</span>
        </div>

        <!-- Password Requirements -->
        <div class="password-requirements">
          <p><ion-icon name="information-circle-outline"></ion-icon> La contraseña debe tener al menos 8 caracteres</p>
        </div>

        <!-- Submit Button -->
        <ion-button
          expand="block"
          type="submit"
          class="submit-btn"
          [disabled]="resetForm.invalid"
          aria-label="Restablecer contraseña">
          <ion-icon name="key-outline" slot="start" aria-hidden="true"></ion-icon>
          Restablecer Contraseña
        </ion-button>
      </form>

      <!-- Back to Login -->
      <div class="back-section">
        <ion-button fill="clear" (click)="goToLogin()">
          <ion-icon name="arrow-back" slot="start"></ion-icon>
          Volver al Login
        </ion-button>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer-section" role="contentinfo">
      <a href="https://historahealth.com" target="_blank" rel="noopener" class="footer-link">
        by Histora Health
      </a>
    </footer>
  </div>
</ion-content>
