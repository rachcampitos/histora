<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" aria-label="Volver">
        <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Verificacion de Identidad</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="verification-content">
  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading()">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando...</p>
  </div>

  <div class="verification-container" *ngIf="!isLoading()">
    <!-- Already Approved State -->
    <div class="status-card approved" *ngIf="isApproved()">
      <div class="status-icon">
        <ion-icon name="checkmark-circle"></ion-icon>
      </div>
      <h2>Cuenta Verificada</h2>
      <p>Tu identidad ha sido verificada exitosamente. Ya puedes ofrecer tus servicios en la plataforma.</p>
      <ion-button expand="block" (click)="goToProfile()">
        <ion-icon name="person-outline" slot="start"></ion-icon>
        Ir a mi Perfil
      </ion-button>
    </div>

    <!-- Under Review State -->
    <div class="status-card under-review" *ngIf="isUnderReview()">
      <div class="status-icon">
        <ion-icon name="time"></ion-icon>
      </div>
      <h2>En Revision</h2>
      <p>Tus documentos estan siendo revisados por nuestro equipo. Este proceso puede tomar de 24 a 48 horas.</p>
      <div class="info-box">
        <ion-icon name="information-circle-outline"></ion-icon>
        <span>Te notificaremos cuando la revision este completa.</span>
      </div>
    </div>

    <!-- Rejected State -->
    <div class="status-card rejected" *ngIf="isRejected()">
      <div class="status-icon">
        <ion-icon name="close-circle"></ion-icon>
      </div>
      <h2>Verificacion Rechazada</h2>
      <p *ngIf="verification()?.rejectionReason">
        Motivo: {{ verification()?.rejectionReason }}
      </p>
      <p *ngIf="!verification()?.rejectionReason">
        Tu solicitud de verificacion fue rechazada. Por favor, revisa los documentos y vuelve a intentarlo.
      </p>
      <ion-button expand="block" color="primary" (click)="loadData()">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        Intentar de Nuevo
      </ion-button>
    </div>

    <!-- Pending / Verification Flow -->
    <ng-container *ngIf="isPending() || isRejected()">
      <!-- Step Indicator -->
      <div class="steps-indicator">
        <div class="step" [class.active]="currentStep() === 'validate_cep'" [class.completed]="currentStep() !== 'validate_cep'">
          <div class="step-number">1</div>
          <span class="step-label">Validar CEP</span>
        </div>
        <div class="step-line" [class.completed]="currentStep() !== 'validate_cep'"></div>
        <div class="step" [class.active]="currentStep() === 'confirm_identity'" [class.completed]="currentStep() === 'upload_documents'">
          <div class="step-number">2</div>
          <span class="step-label">Confirmar</span>
        </div>
        <div class="step-line" [class.completed]="currentStep() === 'upload_documents'"></div>
        <div class="step" [class.active]="currentStep() === 'upload_documents'">
          <div class="step-number">3</div>
          <span class="step-label">Documentos</span>
        </div>
      </div>

      <!-- STEP 1: Validate CEP -->
      <div class="step-content" *ngIf="currentStep() === 'validate_cep'">
        <div class="info-header">
          <h1>Valida tu Registro CEP</h1>
          <p>Ingresa tu numero de DNI para verificar tu registro en el Colegio de Enfermeros del Peru.</p>
        </div>

        <!-- CEP Number Display -->
        <div class="cep-display">
          <ion-icon name="card-outline"></ion-icon>
          <div class="cep-info">
            <span class="label">Tu numero CEP</span>
            <span class="value">{{ cepNumber() }}</span>
          </div>
        </div>

        <!-- DNI Input -->
        <div class="form-section">
          <ion-item lines="none" class="input-item">
            <ion-icon name="id-card-outline" slot="start" class="input-icon"></ion-icon>
            <ion-input
              [value]="dniNumber()"
              (ionInput)="onDniNumberChange($event)"
              placeholder="Numero de DNI (8 digitos)"
              inputmode="numeric"
              maxlength="8"
              aria-label="Numero de DNI">
            </ion-input>
          </ion-item>

          <div class="helper-text" *ngIf="dniNumber().length > 0 && dniNumber().length < 8">
            <ion-icon name="information-circle-outline"></ion-icon>
            <span>El DNI debe tener 8 digitos</span>
          </div>
        </div>

        <!-- Validate Button -->
        <div class="action-section">
          <ion-button
            expand="block"
            [disabled]="!canValidateCep()"
            (click)="validateCep()">
            <ion-spinner name="crescent" *ngIf="isValidatingCep()"></ion-spinner>
            <ng-container *ngIf="!isValidatingCep()">
              <ion-icon name="shield-checkmark-outline" slot="start"></ion-icon>
              Validar CEP
            </ng-container>
          </ion-button>
        </div>

        <!-- Validation Error Message -->
        <div class="error-message" *ngIf="cepValidationMessage() && !cepValidation()?.isValid">
          <ion-icon name="alert-circle"></ion-icon>
          <span>{{ cepValidationMessage() }}</span>
        </div>
      </div>

      <!-- STEP 2: Confirm Identity -->
      <div class="step-content" *ngIf="currentStep() === 'confirm_identity'">
        <div class="info-header">
          <h1>Confirma tu Identidad</h1>
          <p>Hemos encontrado tu registro en el CEP. Por favor confirma que esta foto corresponde a tu identidad.</p>
        </div>

        <!-- CEP Photo Display -->
        <div class="identity-card">
          <div class="photo-container" *ngIf="cepPhotoUrl()">
            <img [src]="cepPhotoUrl()" alt="Foto del registro CEP" class="cep-photo">
            <div class="verified-badge">
              <ion-icon name="shield-checkmark"></ion-icon>
              <span>Registro CEP</span>
            </div>
          </div>

          <div class="no-photo-container" *ngIf="!cepPhotoUrl()">
            <ion-icon name="person-circle-outline"></ion-icon>
            <p>No se encontro foto en el registro CEP</p>
          </div>

          <div class="identity-info">
            <div class="info-row">
              <span class="label">Nombre registrado:</span>
              <span class="value">{{ fullNameOnDni() }}</span>
            </div>
            <div class="info-row">
              <span class="label">DNI:</span>
              <span class="value">{{ dniNumber() }}</span>
            </div>
            <div class="info-row">
              <span class="label">CEP:</span>
              <span class="value">{{ cepNumber() }}</span>
            </div>
          </div>
        </div>

        <!-- Confirmation Question -->
        <div class="confirmation-section">
          <h3>Esta foto corresponde a tu identidad?</h3>

          <div class="confirmation-buttons">
            <ion-button
              expand="block"
              color="success"
              [disabled]="isSubmitting()"
              (click)="confirmIdentity()">
              <ion-spinner name="crescent" *ngIf="isSubmitting()"></ion-spinner>
              <ng-container *ngIf="!isSubmitting()">
                <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                Si, soy yo
              </ng-container>
            </ion-button>

            <ion-button
              expand="block"
              fill="outline"
              color="medium"
              [disabled]="isSubmitting()"
              (click)="rejectIdentity()">
              <ion-icon name="close-circle-outline" slot="start"></ion-icon>
              No, no soy yo
            </ion-button>
          </div>
        </div>
      </div>

      <!-- STEP 3: Upload Documents -->
      <div class="step-content" *ngIf="currentStep() === 'upload_documents'">
        <div class="info-header">
          <h1>Sube tus Documentos</h1>
          <p>Para completar la verificacion, necesitamos fotos claras de tus documentos.</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-section">
          <div class="progress-header">
            <span>Progreso de carga</span>
            <span class="progress-value">{{ uploadProgress() }}%</span>
          </div>
          <ion-progress-bar [value]="uploadProgress() / 100" color="success"></ion-progress-bar>
        </div>

        <!-- Documents Upload -->
        <div class="documents-section">
          <div class="document-list">
            @for (doc of documents(); track doc.type) {
              <div class="document-card" (click)="selectImage(doc.type)">
                <div class="document-preview" [class.has-image]="doc.imageData">
                  <img *ngIf="doc.imageData" [src]="'data:' + doc.mimeType + ';base64,' + doc.imageData" [alt]="doc.label">
                  <div class="placeholder" *ngIf="!doc.imageData">
                    <ion-icon [name]="doc.icon"></ion-icon>
                  </div>
                  <div class="upload-badge" *ngIf="doc.imageData">
                    <ion-icon name="checkmark"></ion-icon>
                  </div>
                </div>
                <div class="document-info">
                  <h4>{{ doc.label }}</h4>
                  <p>{{ doc.description }}</p>
                </div>
                <div class="document-action">
                  <ion-button fill="clear" size="small" *ngIf="!doc.imageData" aria-label="Subir foto">
                    <ion-icon name="camera-outline"></ion-icon>
                  </ion-button>
                  <ion-button fill="clear" size="small" color="danger" *ngIf="doc.imageData" (click)="removeImage(doc.type); $event.stopPropagation()" aria-label="Eliminar foto">
                    <ion-icon name="trash-outline"></ion-icon>
                  </ion-button>
                </div>
              </div>
            }
          </div>
        </div>

        <!-- Submit Button -->
        <div class="submit-section">
          <ion-button
            expand="block"
            [disabled]="!canSubmitDocuments()"
            (click)="submitVerification()">
            <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
            Enviar para Verificacion
          </ion-button>
          <p class="disclaimer">
            Al enviar, confirmas que los documentos son autenticos y te pertenecen.
          </p>
        </div>
      </div>
    </ng-container>
  </div>
</ion-content>
