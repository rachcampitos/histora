<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/nurse/dashboard" text=""></ion-back-button>
    </ion-buttons>
    <ion-title>Solicitudes</ion-title>
  </ion-toolbar>
  <ion-toolbar>
    <ion-segment [value]="currentTab()" (ionChange)="onTabChange($event)">
      <ion-segment-button value="pending">
        <ion-label>
          Pendientes
          @if (pendingCount() > 0) {
            <ion-badge color="warning">{{ pendingCount() }}</ion-badge>
          }
        </ion-label>
      </ion-segment-button>
      <ion-segment-button value="active">
        <ion-label>
          Activas
          @if (activeCount() > 0) {
            <ion-badge color="primary">{{ activeCount() }}</ion-badge>
          }
        </ion-label>
      </ion-segment-button>
      <ion-segment-button value="history">
        <ion-label>Historial</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content class="requests-content">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content
      pullingIcon="chevron-down"
      pullingText="Desliza para actualizar"
      refreshingSpinner="circles"
      refreshingText="Actualizando...">
    </ion-refresher-content>
  </ion-refresher>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state">
      <ion-spinner name="crescent" color="primary"></ion-spinner>
      <p>Cargando solicitudes...</p>
    </div>
  }

  <!-- Pending Requests Tab -->
  @if (!isLoading() && currentTab() === 'pending') {
    <div class="tab-content">
      @if (pendingRequests().length === 0) {
        <div class="empty-state">
          <ion-icon name="clipboard-outline"></ion-icon>
          <p>No hay solicitudes pendientes</p>
          <span>Las nuevas solicitudes apareceran aqui</span>
        </div>
      }
      @if (pendingRequests().length > 0) {
        <ion-list class="request-list">
          @for (request of pendingRequests(); track request) {
            <ion-item-sliding>
              <ion-item (click)="viewRequest(request)" button detail="false">
                <div class="request-card pending-card">
                  <!-- Header -->
                  <div class="card-header">
                    <div class="patient-info">
                      @if (request.patient?.avatar) {
                        <ion-avatar>
                          <img [src]="request.patient?.avatar" alt="Patient" loading="lazy">
                        </ion-avatar>
                      }
                      @if (!request.patient?.avatar) {
                        <div class="avatar-placeholder-circle">
                          <span>{{ getPatientInitials(request) }}</span>
                        </div>
                      }
                      <div class="patient-details">
                        <h3>{{ getPatientFullName(request) }}</h3>
                        <span class="role-badge">Paciente</span>
                        <p class="service-type">{{ request.service.name }}</p>
                      </div>
                    </div>
                    <div class="price-badge">
                      <span class="currency">S/</span>
                      <span class="amount">{{ request.service.price }}</span>
                    </div>
                  </div>
                  <!-- Details -->
                  <div class="card-details">
                    <div class="detail-row">
                      <ion-icon name="location-outline"></ion-icon>
                      <span>{{ request.location.district }}, {{ request.location.city }}</span>
                    </div>
                    <div class="detail-row">
                      <ion-icon name="navigate-outline"></ion-icon>
                      <span>{{ formatDistance(request.distance) }}</span>
                    </div>
                    <div class="detail-row">
                      <ion-icon name="calendar-outline"></ion-icon>
                      <span>{{ request.requestedDate | date:'dd/MM/yyyy' }} - {{ getTimeSlotLabel(request.requestedTimeSlot) }}</span>
                    </div>
                    @if (request.service.durationMinutes) {
                      <div class="detail-row">
                        <ion-icon name="time-outline"></ion-icon>
                        <span>{{ request.service.durationMinutes }} min</span>
                      </div>
                    }
                  </div>
                  <!-- Actions -->
                  <div class="card-actions pending-actions">
                    <ion-button fill="outline" color="danger" (click)="rejectRequest(request, $event)">
                      <ion-icon slot="start" name="close-outline"></ion-icon>
                      Rechazar
                    </ion-button>
                    <ion-button fill="solid" color="success" (click)="acceptRequest(request, $event)">
                      <ion-icon slot="start" name="checkmark-outline"></ion-icon>
                      Aceptar
                    </ion-button>
                  </div>
                </div>
              </ion-item>
              <ion-item-options side="end">
                <ion-item-option color="success" (click)="acceptRequest(request, $event)" aria-label="Aceptar solicitud">
                  <ion-icon slot="icon-only" name="checkmark"></ion-icon>
                </ion-item-option>
                <ion-item-option color="danger" (click)="rejectRequest(request, $event)" aria-label="Rechazar solicitud">
                  <ion-icon slot="icon-only" name="close"></ion-icon>
                </ion-item-option>
              </ion-item-options>
            </ion-item-sliding>
          }
        </ion-list>
      }
    </div>
  }

  <!-- Active Requests Tab -->
  @if (!isLoading() && currentTab() === 'active') {
    <div class="tab-content">
      @if (activeRequests().length === 0) {
        <div class="empty-state">
          <ion-icon name="medical-outline"></ion-icon>
          <p>No tienes servicios activos</p>
          <span>Los servicios que aceptes apareceran aqui</span>
        </div>
      }
      @if (activeRequests().length > 0) {
        <ion-list class="request-list">
          @for (request of activeRequests(); track request) {
            <ion-item (click)="viewRequest(request)" button detail="false">
              <div class="request-card active-card">
                <!-- Status Banner -->
                <div class="status-banner" [ngClass]="'status-' + request.status">
                  <ion-badge [color]="getStatusColor(request.status)">
                    {{ getStatusLabel(request.status) }}
                  </ion-badge>
                </div>
                <!-- Header -->
                <div class="card-header">
                  <div class="patient-info">
                    @if (request.patient?.avatar) {
                      <ion-avatar>
                        <img [src]="request.patient?.avatar" alt="Patient" loading="lazy">
                      </ion-avatar>
                    }
                    @if (!request.patient?.avatar) {
                      <div class="avatar-placeholder-circle">
                        <span>{{ getPatientInitials(request) }}</span>
                      </div>
                    }
                    <div class="patient-details">
                      <h3>{{ getPatientFullName(request) }}</h3>
                      <span class="role-badge">Paciente</span>
                      <p class="service-type">{{ request.service.name }}</p>
                    </div>
                  </div>
                  <div class="price-badge">
                    <span class="currency">S/</span>
                    <span class="amount">{{ request.service.price }}</span>
                  </div>
                </div>
                <!-- Details -->
                <div class="card-details">
                  <div class="detail-row">
                    <ion-icon name="location-outline"></ion-icon>
                    <span class="address">{{ request.location.address }}</span>
                  </div>
                  <div class="detail-row">
                    <ion-icon name="navigate-outline"></ion-icon>
                    <span>{{ formatDistance(request.distance) }}</span>
                  </div>
                  @if (request.scheduledAt) {
                    <div class="detail-row">
                      <ion-icon name="calendar-outline"></ion-icon>
                      <span>{{ request.scheduledAt | date:'dd/MM/yyyy HH:mm' }}</span>
                    </div>
                  }
                  @if (!request.scheduledAt) {
                    <div class="detail-row">
                      <ion-icon name="calendar-outline"></ion-icon>
                      <span>{{ request.requestedDate | date:'dd/MM/yyyy' }} - {{ getTimeSlotLabel(request.requestedTimeSlot) }}</span>
                    </div>
                  }
                </div>
                <!-- Quick Actions -->
                <div class="quick-actions">
                  <ion-button fill="clear" size="small" (click)="callPatient(request, $event)" aria-label="Llamar al paciente">
                    <ion-icon slot="icon-only" name="call-outline"></ion-icon>
                  </ion-button>
                  <ion-button fill="clear" size="small" (click)="openMaps(request, $event)" aria-label="Ver en mapa">
                    <ion-icon slot="icon-only" name="map-outline"></ion-icon>
                  </ion-button>
                </div>
                <!-- Status Update Action -->
                @if (getNextStatus(request.status)) {
                  <div class="card-actions">
                    <ion-button
                      expand="block"
                      [color]="getNextStatusButtonColor(request.status)"
                      (click)="updateStatus(request, getNextStatus(request.status)!, $event)">
                      <ion-icon slot="start" [name]="getNextStatusIcon(request.status)"></ion-icon>
                      {{ getNextStatusButtonLabel(request.status) }}
                    </ion-button>
                  </div>
                }
              </div>
            </ion-item>
          }
        </ion-list>
      }
    </div>
  }

  <!-- History Tab -->
  @if (!isLoading() && currentTab() === 'history') {
    <div class="tab-content">
      @if (historyRequests().length === 0) {
        <div class="empty-state">
          <ion-icon name="time-outline"></ion-icon>
          <p>Sin historial</p>
          <span>Tu historial de servicios aparecera aqui</span>
        </div>
      }
      @if (historyRequests().length > 0) {
        <ion-list class="request-list history-list">
          @for (request of historyRequests(); track request) {
            <ion-item lines="none">
              <div class="request-card history-card">
                <!-- Header -->
                <div class="card-header">
                  <div class="patient-info">
                    @if (request.patient?.avatar) {
                      <ion-avatar class="small">
                        <img [src]="request.patient?.avatar" alt="Patient" loading="lazy">
                      </ion-avatar>
                    }
                    @if (!request.patient?.avatar) {
                      <div class="avatar-placeholder-circle small">
                        <span>{{ getPatientInitials(request) }}</span>
                      </div>
                    }
                    <div class="patient-details">
                      <h3>{{ getPatientFullName(request) }}</h3>
                      <span class="role-badge small">Paciente</span>
                      <p class="service-type">{{ request.service.name }}</p>
                    </div>
                  </div>
                  <ion-badge [color]="getStatusColor(request.status)">
                    {{ getStatusLabel(request.status) }}
                  </ion-badge>
                </div>
                <!-- Details -->
                <div class="card-details compact">
                  <div class="detail-row">
                    <ion-icon name="location-outline"></ion-icon>
                    <span>{{ request.location.district }}</span>
                  </div>
                  <div class="detail-row">
                    <ion-icon name="calendar-outline"></ion-icon>
                    <span>{{ request.completedAt || request.updatedAt | date:'dd/MM/yyyy HH:mm' }}</span>
                  </div>
                  <div class="detail-row price">
                    <ion-icon name="cash-outline"></ion-icon>
                    <span>S/ {{ request.service.price }}</span>
                  </div>
                </div>
                <!-- Rating -->
                @if (request.rating) {
                  <div class="rating-section">
                    <div class="stars">
                      @for (star of [1,2,3,4,5]; track star) {
                        <ion-icon
                          [name]="star <= request.rating! ? 'star' : 'star-outline'"
                          [color]="star <= request.rating! ? 'warning' : 'medium'">
                        </ion-icon>
                      }
                    </div>
                    @if (request.review) {
                      <span class="rating-text">{{ request.review }}</span>
                    }
                  </div>
                }
              </div>
            </ion-item>
          }
        </ion-list>
      }
    </div>
  }
</ion-content>
