<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/nurse/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>Mis Ganancias</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="earnings-content">
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <!-- Period Selector -->
  <div class="period-selector">
    <ion-segment [value]="selectedPeriod()" (ionChange)="onPeriodChange($event)">
      <ion-segment-button value="week">
        <ion-label>Esta semana</ion-label>
      </ion-segment-button>
      <ion-segment-button value="month">
        <ion-label>Este mes</ion-label>
      </ion-segment-button>
      <ion-segment-button value="custom">
        <ion-label>Personalizado</ion-label>
      </ion-segment-button>
    </ion-segment>
  </div>

  <!-- Custom Date Picker -->
  <div class="date-picker-container" *ngIf="showDatePicker()">
    <ion-card class="date-picker-card">
      <ion-card-content>
        <div class="date-inputs">
          <div class="date-input">
            <ion-label>Desde</ion-label>
            <ion-datetime-button datetime="startDate"></ion-datetime-button>
            <ion-modal [keepContentsMounted]="true">
              <ng-template>
                <ion-datetime
                  id="startDate"
                  presentation="date"
                  [value]="customStartDate()"
                  (ionChange)="onStartDateChange($event)"
                  [max]="customEndDate()"
                  locale="es-PE">
                </ion-datetime>
              </ng-template>
            </ion-modal>
          </div>
          <div class="date-input">
            <ion-label>Hasta</ion-label>
            <ion-datetime-button datetime="endDate"></ion-datetime-button>
            <ion-modal [keepContentsMounted]="true">
              <ng-template>
                <ion-datetime
                  id="endDate"
                  presentation="date"
                  [value]="customEndDate()"
                  (ionChange)="onEndDateChange($event)"
                  [min]="customStartDate()"
                  locale="es-PE">
                </ion-datetime>
              </ng-template>
            </ion-modal>
          </div>
        </div>
        <ion-button expand="block" (click)="applyCustomDateRange()">
          Aplicar
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Date Range Display -->
  <div class="date-range-display" *ngIf="!showDatePicker()">
    <ion-icon name="calendar-outline"></ion-icon>
    <span>{{ formatDisplayDate(dateRange().start) }} - {{ formatDisplayDate(dateRange().end) }}</span>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading()">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Cargando ganancias...</p>
  </div>

  <!-- Earnings Summary Cards -->
  <div class="summary-section" *ngIf="!isLoading() && earnings()">
    <div class="summary-grid">
      <!-- Total Earned -->
      <ion-card class="summary-card total-card">
        <ion-card-content>
          <div class="card-icon">
            <ion-icon name="cash-outline"></ion-icon>
          </div>
          <div class="card-info">
            <span class="card-label">Total Ganado</span>
            <span class="card-value">{{ formatCurrency(earnings()!.total) }}</span>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Commission -->
      <ion-card class="summary-card commission-card">
        <ion-card-content>
          <div class="card-icon">
            <ion-icon name="cut-outline"></ion-icon>
          </div>
          <div class="card-info">
            <span class="card-label">Comision (15%)</span>
            <span class="card-value negative">-{{ formatCurrency(earnings()!.commission) }}</span>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Net Earnings -->
      <ion-card class="summary-card net-card">
        <ion-card-content>
          <div class="card-icon highlight">
            <ion-icon name="wallet-outline"></ion-icon>
          </div>
          <div class="card-info">
            <span class="card-label">Ganancia Neta</span>
            <span class="card-value highlight">{{ formatCurrency(earnings()!.net) }}</span>
          </div>
        </ion-card-content>
      </ion-card>

      <!-- Services Count -->
      <ion-card class="summary-card services-card">
        <ion-card-content>
          <div class="card-icon">
            <ion-icon name="medical-outline"></ion-icon>
          </div>
          <div class="card-info">
            <span class="card-label">Servicios</span>
            <span class="card-value">{{ earnings()!.servicesCount }}</span>
          </div>
        </ion-card-content>
      </ion-card>
    </div>
  </div>

  <!-- Services History -->
  <div class="history-section" *ngIf="!isLoading()">
    <div class="section-header">
      <h2>Historial de Servicios</h2>
      <ion-badge color="primary">{{ filteredServices().length }}</ion-badge>
    </div>

    <!-- Services List -->
    <ion-list class="services-list" *ngIf="filteredServices().length > 0">
      <ion-item *ngFor="let service of filteredServices()" lines="full">
        <div class="service-date" slot="start">
          <span class="date-day">{{ formatServiceDate(service.completedAt || service.updatedAt) }}</span>
        </div>
        <ion-label>
          <h3>{{ service.service.name || getCategoryLabel(service.service.category || 'other') }}</h3>
          <p class="patient-name">
            <ion-icon name="person-outline"></ion-icon>
            {{ getPatientName(service) }}
          </p>
        </ion-label>
        <div class="service-amount" slot="end">
          <span class="amount">{{ formatCurrency(service.service.price || 0) }}</span>
          <ion-badge color="success">Completado</ion-badge>
        </div>
      </ion-item>
    </ion-list>

    <!-- Empty State -->
    <div class="empty-state" *ngIf="filteredServices().length === 0">
      <ion-icon name="receipt-outline"></ion-icon>
      <p>No hay servicios completados</p>
      <span>Los servicios completados en este periodo apareceran aqui</span>
    </div>
  </div>
</ion-content>
