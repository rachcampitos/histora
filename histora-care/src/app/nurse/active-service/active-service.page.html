<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon slot="icon-only" name="arrow-back"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Servicio Activo</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="active-service-content">
  @if (isLoading()) {
    <div class="loading-container">
      <ion-spinner name="crescent"></ion-spinner>
      <p>Cargando servicio...</p>
    </div>
  } @else if (request()) {
    <!-- Timer Header -->
    <div class="timer-header">
      <div class="timer-display">
        <ion-icon name="time-outline"></ion-icon>
        <span class="timer-value">{{ elapsedTime() }}</span>
      </div>
      <ion-badge [color]="statusColor()" class="badge-breathe">{{ statusLabel() }}</ion-badge>
    </div>

    <!-- Map Preview -->
    @if (mapUrl() && request()?.status !== 'arrived' && request()?.status !== 'in_progress' && request()?.status !== 'completed') {
      <div class="map-container" (click)="openNavigation()">
        <img [src]="mapUrl()" alt="Ubicacion del paciente" class="map-image">
        <div class="map-overlay">
          <ion-icon name="navigate"></ion-icon>
          <span>Abrir navegacion</span>
        </div>
      </div>
    }

    <!-- Patient Info Card -->
    <ion-card class="patient-card">
      <ion-card-content>
        <div class="patient-header">
          <div class="patient-avatar">
            @if (request()?.patient?.avatar) {
              <img [src]="request()?.patient?.avatar" alt="Paciente" class="patient-avatar-img">
            } @else {
              <span class="patient-initials">{{ patientInitials() }}</span>
            }
          </div>
          <div class="patient-info">
            <h3>{{ patientName() }}</h3>
            <p class="service-type">{{ serviceType() }}</p>
          </div>
          <div class="patient-actions">
            <ion-button fill="clear" (click)="callPatient()" aria-label="Llamar al paciente">
              <ion-icon slot="icon-only" name="call" color="success"></ion-icon>
            </ion-button>
            <ion-button fill="clear" (click)="openChat()" aria-label="Chat con el paciente" class="chat-btn">
              <ion-icon slot="icon-only" name="chatbubble" color="primary"></ion-icon>
              @if (chatUnreadCount() > 0) {
                <ion-badge color="danger" class="chat-badge">{{ chatUnreadCount() }}</ion-badge>
              }
            </ion-button>
          </div>
        </div>

        <div class="address-section">
          <ion-icon name="location-outline"></ion-icon>
          <span>{{ patientAddress() }}</span>
        </div>

        @if (request()?.patientNotes) {
          <div class="notes-section">
            <ion-icon name="document-text-outline"></ion-icon>
            <span>{{ request()?.patientNotes }}</span>
          </div>
        }
      </ion-card-content>
    </ion-card>

    <!-- Security Code Section -->
    @if (request()?.nurseCode) {
      <ion-card class="security-card">
        <ion-card-content>
          <!-- Nurse's own code (show to patient) -->
          <div class="security-header">
            <ion-icon name="shield-checkmark-outline" color="primary"></ion-icon>
            <div>
              <h4>Tu codigo de seguridad</h4>
              <p>Comparte este codigo con el paciente</p>
            </div>
          </div>
          <div class="code-display">
            @for (digit of request()!.nurseCode!.split(''); track $index) {
              <span class="code-digit">{{ digit }}</span>
            }
          </div>

          <!-- Code verification input (arrived + not yet verified) -->
          @if (request()?.status === 'arrived' && !codeVerified()) {
            <div class="code-verification">
              <div class="verification-header">
                <ion-icon name="key-outline" color="warning"></ion-icon>
                <div>
                  <h4>Codigo del paciente</h4>
                  <p>Pide el codigo al paciente e ingresalo aqui</p>
                </div>
              </div>
              <div class="code-inputs">
                @for (digit of codeDigits(); track $index) {
                  <input
                    type="tel"
                    maxlength="1"
                    inputmode="numeric"
                    [value]="digit"
                    (input)="onCodeInput($event, $index)"
                    (keydown)="onCodeKeydown($event, $index)"
                    [disabled]="isVerifyingCode()"
                    class="code-input"
                    autocomplete="off" />
                }
              </div>
              @if (isVerifyingCode()) {
                <div class="verifying-spinner">
                  <ion-spinner name="dots" color="primary"></ion-spinner>
                  <span>Verificando...</span>
                </div>
              }
            </div>
          }

          <!-- Verified badge -->
          @if (codeVerified()) {
            <div class="verified-badge">
              <ion-icon name="checkmark-circle" color="success"></ion-icon>
              <span>Identidad verificada</span>
            </div>
          }
        </ion-card-content>
      </ion-card>
    }

    <!-- Virtual Escort Component -->
    <div class="escort-section">
      <app-virtual-escort
        [serviceRequestId]="request()!._id"
        [initialShares]="activeShares()">
      </app-virtual-escort>
    </div>

    <!-- Compact Status Stepper -->
    <div class="compact-stepper">
      <div class="stepper-track">
        @for (step of statusSteps; track step.key; let i = $index) {
          <div class="stepper-step"
               [class.completed]="isStepCompleted(step.key)"
               [class.active]="isStepActive(step.key)"
               [class.collapsed]="isStepCollapsed(step.key)"
               [attr.data-status]="step.key">
            <div class="stepper-dot">
              @if (isStepCompleted(step.key)) {
                <ion-icon name="checkmark"></ion-icon>
              } @else {
                <ion-icon [name]="step.icon"></ion-icon>
              }
            </div>
            <span class="stepper-label">{{ step.label }}</span>
            <span class="stepper-label-dot"></span>
          </div>
          @if (i < statusSteps.length - 1) {
            <div class="stepper-line"
                 [class.completed]="isLineCompleted(i)"
                 [class.active]="isLineActive(i)"
                 [attr.data-status]="statusSteps[i].key">
              <div class="stepper-line-fill"></div>
            </div>
          }
        }
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="actions-section">
      @if (nextAction) {
        <ion-button
          expand="block"
          class="main-action-btn"
          [class.success-state]="buttonState() === 'success'"
          [attr.data-status]="request()?.status"
          [disabled]="nextAction.disabled"
          (click)="nextAction.action()">
          @if (buttonState() === 'success') {
            <ion-icon name="checkmark-circle" slot="start"></ion-icon>
            Actualizado
          } @else {
            @if (nextAction.icon) {
              <ion-icon [name]="nextAction.icon" slot="start"></ion-icon>
            }
            {{ nextAction.label }}
          }
        </ion-button>
      }

      @if (request()?.status === 'on_the_way') {
        <ion-button
          expand="block"
          fill="outline"
          color="primary"
          class="nav-btn"
          (click)="openNavigation()">
          <ion-icon slot="start" name="navigate"></ion-icon>
          Abrir Navegacion
        </ion-button>
      }
    </div>
  }
</ion-content>

<!-- Panic Button Fixed Footer -->
@if (request()) {
  <ion-footer class="panic-footer ion-no-border">
    <div class="panic-container">
      <app-panic-button
        [serviceRequestId]="request()!._id"
        [patientId]="request()!.patientId"
        [compact]="true">
      </app-panic-button>
    </div>
  </ion-footer>
}

<!-- Check-in Reminder Overlay -->
<app-check-in-reminder></app-check-in-reminder>
