<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goBack()">
        <ion-icon slot="icon-only" name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Mi Perfil</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="saveProfile()" [disabled]="isSaving() || isLoading()">
        <ion-icon slot="icon-only" name="checkmark-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="profile-content">
  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading()">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Cargando perfil...</p>
  </div>

  <ng-container *ngIf="!isLoading()">
    <!-- Profile Header -->
    <div class="profile-header" id="tour-profile-avatar">
      <div class="avatar-container" (click)="changeAvatar()">
        <ion-avatar>
          <img *ngIf="avatar()" [src]="avatar()" alt="Avatar">
          <ion-icon *ngIf="!avatar()" name="person-circle" class="default-avatar"></ion-icon>
        </ion-avatar>
        <div class="avatar-edit-badge">
          <ion-icon name="camera"></ion-icon>
        </div>
        <div class="verified-badge" *ngIf="cepVerified()">
          <ion-icon name="checkmark-circle"></ion-icon>
        </div>
        <div class="avatar-loading" *ngIf="isUploadingAvatar()">
          <ion-spinner name="crescent" color="light"></ion-spinner>
        </div>
      </div>
      <h1 class="nurse-name">{{ fullName() }}</h1>
      <p class="nurse-role">Enfermera Profesional</p>
    </div>

    <!-- CEP Number Section (Display Only) -->
    <div class="section cep-section" id="tour-cep-section">
      <div class="section-header">
        <ion-icon name="ribbon-outline"></ion-icon>
        <h2>Número CEP</h2>
      </div>
      <div class="cep-display">
        <span class="cep-number">{{ cepNumber() }}</span>
        <ion-chip [color]="cepVerified() ? 'success' : 'warning'" class="cep-status">
          <ion-icon [name]="cepVerified() ? 'checkmark-circle' : 'time-outline'"></ion-icon>
          <ion-label>{{ cepVerified() ? 'Verificado' : 'Pendiente' }}</ion-label>
        </ion-chip>
      </div>
      <p class="cep-note">Colegio de Enfermeros del Peru</p>
    </div>

    <!-- Payment Methods Banner (when not configured) -->
    <div class="payment-banner" *ngIf="!yapeNumber() && !plinNumber()" (click)="scrollToPaymentMethods()">
      <div class="banner-icon">
        <ion-icon name="wallet-outline"></ion-icon>
      </div>
      <div class="banner-content">
        <h4>Configura tus metodos de pago</h4>
        <p>Agrega Yape o Plin para recibir pagos de pacientes</p>
      </div>
      <ion-icon name="chevron-forward" class="banner-arrow"></ion-icon>
    </div>

    <!-- Bio Section -->
    <div class="section" id="tour-bio-section">
      <div class="section-header">
        <ion-icon name="document-text-outline"></ion-icon>
        <h2>Acerca de mi</h2>
      </div>
      <ion-textarea
        [value]="bio()"
        (ionInput)="onBioChange($event)"
        placeholder="Escribe una breve descripcion sobre ti, tu experiencia y enfoque profesional..."
        [autoGrow]="true"
        [rows]="4"
        [maxlength]="500"
        class="bio-textarea">
      </ion-textarea>
      <p class="char-count">{{ bio().length }}/500 caracteres</p>
    </div>

    <!-- Specialties Section -->
    <div class="section" id="tour-specialties-section">
      <div class="section-header">
        <ion-icon name="medical-outline"></ion-icon>
        <h2>Especialidades</h2>
      </div>

      <!-- Current Specialties -->
      <div class="specialties-chips" *ngIf="specialties().length > 0">
        <ion-chip *ngFor="let specialty of specialties()" color="primary">
          <ion-label>{{ specialty }}</ion-label>
          <ion-icon name="close-circle" (click)="removeSpecialty(specialty)"></ion-icon>
        </ion-chip>
      </div>
      <p class="empty-text" *ngIf="specialties().length === 0">
        Agrega tus especialidades para que los pacientes puedan encontrarte
      </p>

      <!-- Add New Specialty -->
      <div class="add-specialty">
        <ion-input
          [value]="newSpecialty()"
          (ionInput)="onNewSpecialtyChange($event)"
          placeholder="Agregar especialidad..."
          (keyup.enter)="addSpecialty()">
        </ion-input>
        <ion-button fill="clear" (click)="addSpecialty()" [disabled]="!newSpecialty()">
          <ion-icon slot="icon-only" name="add-circle-outline"></ion-icon>
        </ion-button>
      </div>

      <!-- Common Specialties Suggestions -->
      <div class="suggestions" *ngIf="getAvailableCommonSpecialties().length > 0">
        <p class="suggestions-label">Sugerencias:</p>
        <div class="suggestions-chips">
          <ion-chip
            *ngFor="let specialty of getAvailableCommonSpecialties()"
            outline
            color="medium"
            (click)="addCommonSpecialty(specialty)">
            <ion-icon name="add-outline"></ion-icon>
            <ion-label>{{ specialty }}</ion-label>
          </ion-chip>
        </div>
      </div>
    </div>

    <!-- Experience Section -->
    <div class="section">
      <div class="section-header">
        <ion-icon name="school-outline"></ion-icon>
        <h2>Años de Experiencia</h2>
      </div>
      <div class="experience-input">
        <ion-input
          type="number"
          [value]="yearsOfExperience()"
          (ionInput)="onYearsChange($event)"
          [min]="0"
          [max]="50"
          placeholder="0">
        </ion-input>
        <span class="experience-label">años</span>
      </div>
    </div>

    <!-- Location Section -->
    <div class="section" id="tour-location-section">
      <div class="section-header">
        <ion-icon name="location-outline"></ion-icon>
        <h2>Ubicacion de Servicio</h2>
      </div>

      <!-- Current Location Display -->
      <div class="location-display" *ngIf="locationDistrict()">
        <ion-icon name="checkmark-circle" color="success"></ion-icon>
        <span>{{ locationDistrict() }}, {{ locationCity() }}</span>
      </div>
      <p class="empty-text" *ngIf="!locationDistrict()">
        Indica tu ubicacion para que los pacientes cercanos puedan encontrarte
      </p>

      <!-- Location Form -->
      <div class="location-form">
        <div class="form-row">
          <div class="form-group">
            <label>Departamento</label>
            <ion-select
              [value]="selectedDepartamento()"
              (ionChange)="onDepartamentoChange($event)"
              interface="popover"
              placeholder="Selecciona"
              class="location-select">
              <ion-select-option *ngFor="let dept of departamentos()" [value]="dept.id">
                {{ dept.nombre }}
              </ion-select-option>
            </ion-select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Distrito</label>
            <div class="search-container">
              <ion-input
                [value]="distritoSearch()"
                (ionInput)="onDistritoSearchInput($event)"
                (ionFocus)="onDistritoSearchFocus()"
                (ionBlur)="onDistritoSearchBlur()"
                placeholder="Buscar distrito..."
                class="distrito-input"
                [class.has-value]="locationDistrict()">
                <ion-icon slot="start" name="search-outline"></ion-icon>
              </ion-input>

              <ion-button *ngIf="locationDistrict()" fill="clear" size="small" (click)="clearDistrito()" class="clear-btn">
                <ion-icon name="close-circle"></ion-icon>
              </ion-button>

              <div class="search-results" *ngIf="showDistritoResults() && filteredDistritos().length > 0">
                <div class="result-item"
                     *ngFor="let distrito of filteredDistritos()"
                     (mousedown)="selectDistrito(distrito); $event.preventDefault()"
                     (touchend)="selectDistrito(distrito); $event.preventDefault()">
                  <ion-icon name="location-outline"></ion-icon>
                  <span>{{ distrito.nombre }}</span>
                  <small *ngIf="distrito.zona">{{ distrito.zona | titlecase }}</small>
                </div>
              </div>

              <div class="search-results empty" *ngIf="showDistritoResults() && distritoSearch().length >= 2 && filteredDistritos().length === 0">
                <p>No se encontraron distritos</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <p class="helper-text">
        <ion-icon name="shield-checkmark-outline"></ion-icon>
        Tu ubicacion exacta solo se comparte cuando aceptas un servicio
      </p>
    </div>

    <!-- Service Radius Section -->
    <div class="section" id="tour-radius-section">
      <div class="section-header">
        <ion-icon name="locate-outline"></ion-icon>
        <h2>Radio de Servicio</h2>
      </div>
      <div class="radius-display">
        <span class="radius-value">{{ serviceRadius() }} km</span>
      </div>
      <ion-range
        [value]="serviceRadius()"
        (ionInput)="onRadiusChange($event)"
        [min]="1"
        [max]="30"
        [step]="1"
        [pin]="true"
        [pinFormatter]="radiusFormatter"
        color="primary">
        <ion-label slot="start">1 km</ion-label>
        <ion-label slot="end">30 km</ion-label>
      </ion-range>
      <p class="helper-text">
        Define la distancia maxima a la que estas dispuesta a desplazarte para atender pacientes
      </p>
    </div>

    <!-- Availability Schedule Section -->
    <div class="section" id="tour-schedule-section">
      <div class="section-header">
        <ion-icon name="calendar-outline"></ion-icon>
        <h2>Horario de Disponibilidad</h2>
      </div>

      <!-- Days of Week -->
      <div class="days-selector">
        <p class="subsection-label">Dias disponibles</p>
        <div class="days-grid">
          <div
            *ngFor="let day of dayOptions"
            class="day-chip"
            [class.selected]="isDaySelected(day.value)"
            (click)="toggleDay(day.value)">
            {{ day.shortLabel }}
          </div>
        </div>
      </div>

      <!-- Time Range -->
      <div class="time-selector">
        <div class="time-field">
          <p class="subsection-label">Desde</p>
          <ion-datetime-button datetime="from-time"></ion-datetime-button>
          <ion-modal [keepContentsMounted]="true">
            <ng-template>
              <ion-datetime
                id="from-time"
                presentation="time"
                [value]="'2024-01-01T' + availableFrom() + ':00'"
                (ionChange)="onFromTimeChange($event)"
                [hourCycle]="'h12'"
                [locale]="'es-PE'">
              </ion-datetime>
            </ng-template>
          </ion-modal>
        </div>
        <div class="time-separator">
          <ion-icon name="arrow-forward-outline"></ion-icon>
        </div>
        <div class="time-field">
          <p class="subsection-label">Hasta</p>
          <ion-datetime-button datetime="to-time"></ion-datetime-button>
          <ion-modal [keepContentsMounted]="true">
            <ng-template>
              <ion-datetime
                id="to-time"
                presentation="time"
                [value]="'2024-01-01T' + availableTo() + ':00'"
                (ionChange)="onToTimeChange($event)"
                [hourCycle]="'h12'"
                [locale]="'es-PE'">
              </ion-datetime>
            </ng-template>
          </ion-modal>
        </div>
      </div>
    </div>

    <!-- Save Button -->
    <div class="save-section" id="tour-save-button">
      <ion-button
        expand="block"
        (click)="saveProfile()"
        [disabled]="isSaving()"
        class="save-button">
        <ion-spinner *ngIf="isSaving()" name="crescent" slot="start"></ion-spinner>
        <span *ngIf="!isSaving()">Guardar Cambios</span>
        <span *ngIf="isSaving()">Guardando...</span>
      </ion-button>
    </div>

    <!-- Payment Methods Section (P2P) -->
    <div class="section payment-methods-section">
      <div class="section-header">
        <ion-icon name="wallet-outline"></ion-icon>
        <h2>Metodos de Pago</h2>
      </div>
      <p class="section-description">Los pacientes veran estos datos para pagarte directamente</p>

      <!-- Yape -->
      <div class="payment-method">
        <div class="payment-method-header">
          <div class="payment-logo yape">
            <span>Y</span>
          </div>
          <span class="payment-label">Yape</span>
        </div>
        <ion-input
          [value]="yapeNumber()"
          (ionInput)="onYapeNumberChange($event)"
          type="tel"
          inputmode="numeric"
          maxlength="9"
          placeholder="987654321"
          class="payment-input">
        </ion-input>
      </div>

      <!-- Plin -->
      <div class="payment-method">
        <div class="payment-method-header">
          <div class="payment-logo plin">
            <span>P</span>
          </div>
          <span class="payment-label">Plin</span>
        </div>
        <ion-input
          [value]="plinNumber()"
          (ionInput)="onPlinNumberChange($event)"
          type="tel"
          inputmode="numeric"
          maxlength="9"
          placeholder="987654321"
          class="payment-input">
        </ion-input>
      </div>

      <!-- Cash Toggle -->
      <ion-item lines="none" class="cash-toggle">
        <ion-icon name="cash-outline" slot="start" color="success"></ion-icon>
        <ion-label>
          <h3>Acepto efectivo</h3>
          <p>Los pacientes pueden pagarte en efectivo</p>
        </ion-label>
        <ion-toggle [checked]="acceptsCash()" (ionChange)="onAcceptsCashChange($event)" slot="end"></ion-toggle>
      </ion-item>

      <p class="payment-note">
        <ion-icon name="information-circle-outline"></ion-icon>
        Debes tener al menos un metodo de pago activo
      </p>
    </div>

    <!-- Subscription Section -->
    <div class="section subscription-section">
      <div class="section-header">
        <ion-icon name="ribbon-outline"></ion-icon>
        <h2>Mi Suscripcion</h2>
      </div>

      <ion-item button routerLink="/nurse/subscription" detail="true" class="subscription-item">
        <div class="subscription-info" slot="start">
          <span class="plan-name">Plan Basico</span>
          <span class="plan-status">Gratis</span>
        </div>
        <ion-label>
          <p>Mejora tu plan para mas beneficios</p>
        </ion-label>
      </ion-item>
    </div>

    <!-- Settings Section -->
    <div class="section settings-section">
      <div class="section-header">
        <ion-icon name="settings-outline"></ion-icon>
        <h2>Configuracion</h2>
      </div>

      <ion-list lines="none" class="settings-list">
        <ion-item button (click)="openThemeSelector()" detail="true">
          <ion-icon [name]="themeService.getThemeIcon(themeService.currentTheme())" slot="start" class="setting-icon"></ion-icon>
          <ion-label>
            <h3>Tema</h3>
            <p>{{ themeService.getThemeLabel(themeService.currentTheme()) }}</p>
          </ion-label>
        </ion-item>
        <ion-item button (click)="replayTour()" detail="true">
          <ion-icon name="school-outline" slot="start" class="setting-icon"></ion-icon>
          <ion-label>
            <h3>Ver tutorial</h3>
            <p>Repetir el tutorial de la app</p>
          </ion-label>
        </ion-item>
      </ion-list>
    </div>

    <!-- Logout Section -->
    <div class="logout-section">
      <ion-button
        expand="block"
        fill="outline"
        color="danger"
        (click)="confirmLogout()"
        class="logout-button">
        <ion-icon slot="start" name="log-out-outline"></ion-icon>
        Cerrar Sesion
      </ion-button>
    </div>

    <!-- App Version -->
    <div class="app-version">
      <p>NurseLite v1.0.0</p>
      <p class="powered-by">by Histora Health</p>
    </div>
  </ng-container>
</ion-content>
