<section class="content">
  <div class="content-block">
    <div class="block-header">
      <app-breadcrumb [title]="'Reportes y Analíticas'" [items]="['Admin']" [active_item]="'Reportes'"></app-breadcrumb>
    </div>

    <!-- Controls -->
    <div class="controls-row">
      <mat-form-field appearance="outline" class="period-select">
        <mat-label>Período</mat-label>
        <mat-select [(ngModel)]="selectedPeriod" (selectionChange)="onPeriodChange()">
          @for (period of periodOptions; track period.value) {
            <mat-option [value]="period.value">{{ period.label }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <div class="export-buttons">
        <button mat-stroked-button (click)="exportReport('pdf')">
          <mat-icon>picture_as_pdf</mat-icon>
          Exportar PDF
        </button>
        <button mat-stroked-button (click)="exportReport('excel')">
          <mat-icon>table_chart</mat-icon>
          Exportar Excel
        </button>
      </div>
    </div>

    @if (isLoading) {
      <div class="loading-container">
        <mat-progress-spinner color="primary" mode="indeterminate" [diameter]="50"></mat-progress-spinner>
      </div>
    } @else {
      <!-- Business KPIs -->
      <div class="section-title">
        <mat-icon>analytics</mat-icon>
        <h3>Métricas de Negocio</h3>
      </div>
      <div class="row">
        @for (kpi of businessKpis; track kpi.label) {
          <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
            <div class="card kpi-card">
              <div class="card-body">
                <div class="kpi-header">
                  <mat-icon class="kpi-icon" [ngClass]="kpi.iconClass">{{ kpi.icon }}</mat-icon>
                  <span class="kpi-change positive">+{{ kpi.change }}%</span>
                </div>
                <h3 class="kpi-value">{{ kpi.value }}</h3>
                <span class="kpi-label">{{ kpi.label }}</span>
                <span class="kpi-sublabel">{{ kpi.changeLabel }}</span>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Operational KPIs -->
      <div class="section-title">
        <mat-icon>speed</mat-icon>
        <h3>Métricas Operativas</h3>
      </div>
      <div class="row">
        @for (kpi of operationalKpis; track kpi.label) {
          <div class="col-xl-3 col-lg-6 col-md-6 col-sm-12">
            <div class="card kpi-card">
              <div class="card-body">
                <div class="kpi-header">
                  <mat-icon class="kpi-icon" [ngClass]="kpi.iconClass">{{ kpi.icon }}</mat-icon>
                  <span class="kpi-change positive">+{{ kpi.change }}</span>
                </div>
                <h3 class="kpi-value">{{ kpi.value }}</h3>
                <span class="kpi-label">{{ kpi.label }}</span>
                <span class="kpi-sublabel">{{ kpi.changeLabel }}</span>
              </div>
            </div>
          </div>
        }
      </div>

      <!-- Revenue Chart -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="header">
              <h2>
                <mat-icon class="header-icon">show_chart</mat-icon>
                Ingresos (GMV vs Comisiones)
              </h2>
            </div>
            <div class="body">
              <apx-chart
                [series]="revenueChartOptions.series"
                [chart]="revenueChartOptions.chart"
                [xaxis]="revenueChartOptions.xaxis"
                [stroke]="revenueChartOptions.stroke"
                [dataLabels]="revenueChartOptions.dataLabels"
                [yaxis]="revenueChartOptions.yaxis"
                [legend]="revenueChartOptions.legend"
                [fill]="revenueChartOptions.fill"
                [tooltip]="revenueChartOptions.tooltip"
                [colors]="revenueChartOptions.colors"
                [theme]="revenueChartOptions.theme"
                [grid]="revenueChartOptions.grid"
              ></apx-chart>
            </div>
          </div>
        </div>
      </div>

      <!-- Secondary Charts Row -->
      <div class="row">
        <div class="col-xl-4 col-lg-12">
          <div class="card">
            <div class="header">
              <h2>
                <mat-icon class="header-icon">pie_chart</mat-icon>
                Enfermeras por Plan
              </h2>
            </div>
            <div class="body">
              <apx-chart
                [series]="nurseDistributionChartOptions.series"
                [chart]="nurseDistributionChartOptions.chart"
                [labels]="nurseDistributionChartOptions.labels"
                [colors]="nurseDistributionChartOptions.colors"
                [legend]="nurseDistributionChartOptions.legend"
                [plotOptions]="nurseDistributionChartOptions.plotOptions"
                [dataLabels]="nurseDistributionChartOptions.dataLabels"
                [theme]="nurseDistributionChartOptions.theme"
              ></apx-chart>
            </div>
          </div>
        </div>

        <div class="col-xl-4 col-lg-6">
          <div class="card">
            <div class="header">
              <h2>
                <mat-icon class="header-icon">bar_chart</mat-icon>
                Servicios Mensuales
              </h2>
            </div>
            <div class="body">
              <apx-chart
                [series]="servicesChartOptions.series"
                [chart]="servicesChartOptions.chart"
                [xaxis]="servicesChartOptions.xaxis"
                [stroke]="servicesChartOptions.stroke"
                [dataLabels]="servicesChartOptions.dataLabels"
                [colors]="servicesChartOptions.colors"
                [theme]="servicesChartOptions.theme"
                [plotOptions]="servicesChartOptions.plotOptions"
                [grid]="servicesChartOptions.grid"
              ></apx-chart>
            </div>
          </div>
        </div>

        <div class="col-xl-4 col-lg-6">
          <div class="card">
            <div class="header">
              <h2>
                <mat-icon class="header-icon">groups</mat-icon>
                Crecimiento de Pacientes
              </h2>
            </div>
            <div class="body">
              <apx-chart
                [series]="patientGrowthChartOptions.series"
                [chart]="patientGrowthChartOptions.chart"
                [xaxis]="patientGrowthChartOptions.xaxis"
                [stroke]="patientGrowthChartOptions.stroke"
                [dataLabels]="patientGrowthChartOptions.dataLabels"
                [colors]="patientGrowthChartOptions.colors"
                [yaxis]="patientGrowthChartOptions.yaxis"
                [theme]="patientGrowthChartOptions.theme"
                [fill]="patientGrowthChartOptions.fill"
                [grid]="patientGrowthChartOptions.grid"
              ></apx-chart>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Performers -->
      <div class="row">
        <div class="col-xl-6">
          <div class="card">
            <div class="header">
              <h2>
                <mat-icon class="header-icon">emoji_events</mat-icon>
                Top 5 Enfermeras por Ingresos
              </h2>
            </div>
            <div class="body">
              <div class="top-list">
                @for (nurse of topNursesByRevenue; track nurse.rank) {
                  <div class="top-item">
                    <span class="rank" [class.gold]="nurse.rank === 1" [class.silver]="nurse.rank === 2" [class.bronze]="nurse.rank === 3">
                      {{ nurse.rank }}
                    </span>
                    <div class="info">
                      <span class="name">{{ nurse.name }}</span>
                      <span class="detail">
                        CEP: {{ nurse.cep }} • {{ nurse.services }} servicios
                        <span class="rating">
                          @for (_ of getRatingStars(nurse.rating || 0); track $index) {
                            <mat-icon class="star-icon filled">star</mat-icon>
                          }
                          @if (hasHalfStar(nurse.rating || 0)) {
                            <mat-icon class="star-icon filled">star_half</mat-icon>
                          }
                          {{ nurse.rating }}
                        </span>
                      </span>
                    </div>
                    <span class="value">{{ nurse.valueLabel }}</span>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-6">
          <div class="card">
            <div class="header">
              <h2>
                <mat-icon class="header-icon">workspace_premium</mat-icon>
                Top 5 Enfermeras por Servicios
              </h2>
            </div>
            <div class="body">
              <div class="top-list">
                @for (nurse of topNursesByServices; track nurse.rank) {
                  <div class="top-item">
                    <span class="rank" [class.gold]="nurse.rank === 1" [class.silver]="nurse.rank === 2" [class.bronze]="nurse.rank === 3">
                      {{ nurse.rank }}
                    </span>
                    <div class="info">
                      <span class="name">{{ nurse.name }}</span>
                      <span class="detail">
                        CEP: {{ nurse.cep }}
                        <span class="rating">
                          @for (_ of getRatingStars(nurse.rating || 0); track $index) {
                            <mat-icon class="star-icon filled">star</mat-icon>
                          }
                          @if (hasHalfStar(nurse.rating || 0)) {
                            <mat-icon class="star-icon filled">star_half</mat-icon>
                          }
                          {{ nurse.rating }}
                        </span>
                      </span>
                    </div>
                    <span class="value services-value">{{ nurse.valueLabel }}</span>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Region Distribution -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="header">
              <h2>
                <mat-icon class="header-icon">location_on</mat-icon>
                Distribución por Zona (Lima)
              </h2>
            </div>
            <div class="body">
              <div class="region-table">
                <div class="region-header">
                  <span class="region-col">Zona</span>
                  <span class="region-col">Servicios</span>
                  <span class="region-col">Ingresos</span>
                  <span class="region-col">Enfermeras</span>
                  <span class="region-col">Ticket Prom.</span>
                </div>
                @for (region of regionData; track region.region) {
                  <div class="region-row">
                    <span class="region-col region-name">
                      <mat-icon class="location-icon">place</mat-icon>
                      {{ region.region }}
                    </span>
                    <span class="region-col">{{ region.services }}</span>
                    <span class="region-col revenue">S/. {{ region.revenue | number }}</span>
                    <span class="region-col">{{ region.nurses }}</span>
                    <span class="region-col">S/. {{ (region.revenue / region.services) | number:'1.0-0' }}</span>
                  </div>
                }
              </div>
            </div>
          </div>
        </div>
      </div>
    }
  </div>
</section>
