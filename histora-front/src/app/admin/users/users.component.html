<section class="content">
  <div class="content-block">
    <div class="block-header">
      <app-breadcrumb [title]="'Gestión de Usuarios'" [items]="['Admin']" [active_item]="'Usuarios'"></app-breadcrumb>
    </div>

    <div class="card">
      <div class="header d-flex justify-content-between align-items-center">
        <h2>Usuarios del Sistema</h2>
        <button mat-flat-button color="primary" (click)="openCreateDialog()">
          <mat-icon>person_add</mat-icon>
          Nuevo Usuario
        </button>
      </div>

      <div class="body">
        <!-- Filters -->
        <div class="filters-row">
          <mat-form-field appearance="outline" class="filter-field search-field">
            <mat-label>Buscar por nombre o email</mat-label>
            <input matInput [(ngModel)]="searchTerm" (keyup.enter)="applyFilter()">
            <button mat-icon-button matSuffix (click)="applyFilter()" matTooltip="Buscar">
              <mat-icon>search</mat-icon>
            </button>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Rol</mat-label>
            <mat-select [(ngModel)]="roleFilter" (selectionChange)="applyFilter()">
              <mat-option value="">Todos</mat-option>
              @for (role of roleOptions; track role.value) {
                <mat-option [value]="role.value">{{ role.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Estado</mat-label>
            <mat-select [(ngModel)]="statusFilter" (selectionChange)="applyFilter()">
              <mat-option value="">Todos</mat-option>
              @for (status of statusOptions; track status.value) {
                <mat-option [value]="status.value">{{ status.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          @if (searchTerm || roleFilter || statusFilter) {
            <button mat-stroked-button (click)="clearFilters()" class="clear-btn">
              <mat-icon>clear</mat-icon>
              Limpiar
            </button>
          }
        </div>

        @if (isLoading) {
          <div class="loading-container">
            <mat-progress-spinner color="primary" mode="indeterminate" [diameter]="50"></mat-progress-spinner>
          </div>
        } @else {
          <div class="table-responsive">
            <table mat-table [dataSource]="dataSource" matSort class="advance-table">
              <!-- User Column -->
              <ng-container matColumnDef="user">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Usuario</th>
                <td mat-cell *matCellDef="let row">
                  <div class="user-info">
                    @if (row.avatar) {
                      <img [src]="row.avatar" alt="Avatar" class="user-avatar-img">
                    } @else {
                      <mat-icon class="user-avatar">account_circle</mat-icon>
                    }
                    <span class="user-name">{{ row.firstName }} {{ row.lastName }}</span>
                  </div>
                </td>
              </ng-container>

              <!-- Email Column -->
              <ng-container matColumnDef="email">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Email</th>
                <td mat-cell *matCellDef="let row">
                  <div class="email-cell">
                    {{ row.email }}
                    @if (row.authProvider === 'google') {
                      <mat-icon class="google-icon" matTooltip="Registrado con Google">g_mobiledata</mat-icon>
                    }
                  </div>
                </td>
              </ng-container>

              <!-- Role Column -->
              <ng-container matColumnDef="role">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Rol</th>
                <td mat-cell *matCellDef="let row">
                  <span class="badge" [ngClass]="getRoleClass(row.role)">{{ getRoleLabel(row.role) }}</span>
                </td>
              </ng-container>

              <!-- Clinic Column -->
              <ng-container matColumnDef="clinic">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Clínica</th>
                <td mat-cell *matCellDef="let row">{{ row.clinic || '-' }}</td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Estado</th>
                <td mat-cell *matCellDef="let row">
                  <span class="badge" [ngClass]="getStatusClass(row.status)">{{ getStatusLabel(row.status) }}</span>
                </td>
              </ng-container>

              <!-- Created At Column -->
              <ng-container matColumnDef="createdAt">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Fecha Registro</th>
                <td mat-cell *matCellDef="let row">{{ row.createdAt | date: 'dd/MM/yyyy HH:mm' }}</td>
              </ng-container>

              <!-- Last Login Column -->
              <ng-container matColumnDef="lastLogin">
                <th mat-header-cell *matHeaderCellDef mat-sort-header>Último acceso</th>
                <td mat-cell *matCellDef="let row">
                  @if (row.lastLoginAt) {
                    {{ row.lastLoginAt | date: 'dd/MM/yyyy HH:mm' }}
                  } @else {
                    <span class="text-muted">Nunca</span>
                  }
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Acciones</th>
                <td mat-cell *matCellDef="let row">
                  <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="Opciones">
                    <mat-icon>more_vert</mat-icon>
                  </button>
                  <mat-menu #menu="matMenu">
                    <button mat-menu-item (click)="viewUser(row)">
                      <mat-icon>visibility</mat-icon>
                      <span>Ver perfil</span>
                    </button>
                    <button mat-menu-item (click)="editUser(row)">
                      <mat-icon>edit</mat-icon>
                      <span>Editar</span>
                    </button>
                    @if (row.authProvider !== 'google') {
                      <button mat-menu-item (click)="resetPassword(row)">
                        <mat-icon>lock_reset</mat-icon>
                        <span>Restablecer contraseña</span>
                      </button>
                    }
                    <button mat-menu-item (click)="toggleStatus(row)">
                      <mat-icon>{{ row.status === 'active' ? 'block' : 'check_circle' }}</mat-icon>
                      <span>{{ row.status === 'active' ? 'Desactivar' : 'Activar' }}</span>
                    </button>
                    <button mat-menu-item (click)="deleteUser(row)" class="text-danger">
                      <mat-icon color="warn">delete</mat-icon>
                      <span>Eliminar</span>
                    </button>
                  </mat-menu>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

              <tr class="mat-row" *matNoDataRow>
                <td class="mat-cell no-data-cell" colspan="8">
                  <div class="no-results">
                    <mat-icon>search_off</mat-icon>
                    <p>No se encontraron usuarios</p>
                  </div>
                </td>
              </tr>
            </table>
          </div>

          <mat-paginator
            [length]="totalUsers"
            [pageSize]="pageSize"
            [pageIndex]="currentPage"
            [pageSizeOptions]="[10, 25, 50]"
            (page)="onPageChange($event)"
            showFirstLastButtons>
          </mat-paginator>
        }
      </div>
    </div>
  </div>
</section>
