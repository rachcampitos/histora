<section class="content">
  <div class="content-block">
    <div class="block-header">
      <app-breadcrumb [title]="'Buscar Médicos'" [items]="['Paciente']" [active_item]="'Médicos'"></app-breadcrumb>
    </div>

    <div class="row clearfix">
      <div class="col-lg-12">
        <!-- Filters -->
        <mat-card class="filters-card">
          <mat-card-content>
            <div class="filters-row">
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Buscar por nombre</mat-label>
                <input matInput
                       [(ngModel)]="searchTerm"
                       (keyup)="applyFilter()">
                <mat-icon matSuffix>search</mat-icon>
              </mat-form-field>

              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Especialidad</mat-label>
                <mat-select [(ngModel)]="selectedSpecialty" (selectionChange)="onSpecialtyChange()">
                  <mat-option value="">Todas</mat-option>
                  @for (specialty of specialties; track specialty) {
                    <mat-option [value]="specialty">{{ specialty }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <button mat-stroked-button (click)="clearFilters()">
                <mat-icon>clear</mat-icon> Limpiar
              </button>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Doctors Table -->
        <mat-card>
          <mat-card-content>
            @if (isLoading) {
              <div class="loading-container">
                <mat-spinner diameter="50"></mat-spinner>
              </div>
            } @else {
              <div class="table-responsive">
                <table mat-table [dataSource]="dataSource" matSort class="doctors-table">
                  <!-- Photo Column -->
                  <ng-container matColumnDef="photo">
                    <th mat-header-cell *matHeaderCellDef>Foto</th>
                    <td mat-cell *matCellDef="let doctor">
                      <img [src]="doctor.profileImage || 'assets/images/user/doctor.jpg'"
                           [alt]="getFullName(doctor)"
                           class="doctor-photo">
                    </td>
                  </ng-container>

                  <!-- Name Column -->
                  <ng-container matColumnDef="name">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Nombre</th>
                    <td mat-cell *matCellDef="let doctor">
                      <div class="doctor-name">{{ getFullName(doctor) }}</div>
                      @if (doctor.licenseNumber) {
                        <div class="doctor-license">CMP: {{ doctor.licenseNumber }}</div>
                      }
                    </td>
                  </ng-container>

                  <!-- Specialty Column -->
                  <ng-container matColumnDef="specialty">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Especialidad</th>
                    <td mat-cell *matCellDef="let doctor">
                      <span class="specialty-badge">{{ doctor.specialty }}</span>
                      @if (doctor.subspecialties?.length) {
                        <div class="subspecialties">
                          @for (sub of doctor.subspecialties; track sub) {
                            <span class="sub-badge">{{ sub }}</span>
                          }
                        </div>
                      }
                    </td>
                  </ng-container>

                  <!-- Rating Column -->
                  <ng-container matColumnDef="rating">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Calificación</th>
                    <td mat-cell *matCellDef="let doctor">
                      <div class="rating">
                        @for (star of getRatingStars(doctor.averageRating); track star) {
                          <mat-icon [class.filled]="star <= doctor.averageRating">star</mat-icon>
                        }
                        <span class="rating-value">{{ doctor.averageRating?.toFixed(1) || '0.0' }}</span>
                      </div>
                      <div class="reviews-count">({{ doctor.totalReviews || 0 }} reseñas)</div>
                    </td>
                  </ng-container>

                  <!-- Consultation Fee Column -->
                  <ng-container matColumnDef="consultationFee">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Tarifa</th>
                    <td mat-cell *matCellDef="let doctor">
                      @if (doctor.consultationFee) {
                        <span class="fee">{{ formatCurrency(doctor.consultationFee, doctor.currency) }}</span>
                      } @else {
                        <span class="fee-na">Consultar</span>
                      }
                    </td>
                  </ng-container>

                  <!-- Actions Column -->
                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Acciones</th>
                    <td mat-cell *matCellDef="let doctor">
                      <button mat-stroked-button color="primary"
                              matTooltip="Ver Perfil"
                              (click)="viewProfile(doctor)">
                        <mat-icon>visibility</mat-icon> Ver Perfil
                      </button>
                      <button mat-raised-button color="primary"
                              matTooltip="Agendar Cita"
                              (click)="bookAppointment(doctor)"
                              class="ml-2">
                        <mat-icon>event</mat-icon> Agendar
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

                  <!-- No Data Row -->
                  <tr class="mat-row" *matNoDataRow>
                    <td class="mat-cell" colspan="6">
                      <div class="no-data">
                        <mat-icon>search_off</mat-icon>
                        <p>No se encontraron médicos</p>
                      </div>
                    </td>
                  </tr>
                </table>
              </div>

              <mat-paginator [pageSizeOptions]="[5, 10, 25]"
                             showFirstLastButtons
                             aria-label="Seleccionar página">
              </mat-paginator>
            }
          </mat-card-content>
        </mat-card>
      </div>
    </div>
  </div>
</section>
