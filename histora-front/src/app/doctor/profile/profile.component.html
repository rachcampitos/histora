<section class="content">
  <div class="content-block">
    <div class="block-header">
      <app-breadcrumb [title]="'Mi Perfil'" [items]="['Doctor']" [active_item]="'Perfil'"></app-breadcrumb>
    </div>

    @if (isLoading) {
      <div class="loading-container">
        <mat-spinner diameter="50"></mat-spinner>
      </div>
    } @else {
      <!-- Profile Header -->
      <div class="row clearfix">
        <div class="col-lg-12">
          <mat-card class="profile-header-card">
            <div class="profile-header">
              <div class="profile-avatar">
                <img [src]="userAvatar || doctorProfile?.profileImage || 'assets/images/user/doctor.jpg'"
                     [alt]="doctorProfile?.firstName">
              </div>
              <div class="profile-info">
                <h2>Dr. {{ displayFirstName }} {{ displayLastName }}</h2>
                <p class="specialty">{{ doctorProfile?.specialty }}</p>
                @if (doctorProfile?.licenseNumber || doctorProfile?.rne) {
                  <p class="license">
                    @if (doctorProfile?.licenseNumber) {
                      <span>CMP: {{ doctorProfile?.licenseNumber }}</span>
                    }
                    @if (doctorProfile?.licenseNumber && doctorProfile?.rne) {
                      <span> | </span>
                    }
                    @if (doctorProfile?.rne) {
                      <span>RNE: {{ doctorProfile?.rne }}</span>
                    }
                  </p>
                }
                <div class="rating">
                  @for (star of [1,2,3,4,5]; track star) {
                    <mat-icon [class.filled]="star <= (doctorProfile?.averageRating || 0)">star</mat-icon>
                  }
                  <span>({{ doctorProfile?.totalReviews || 0 }} reseñas)</span>
                </div>
              </div>
              <div class="profile-status">
                @if (doctorProfile?.isPublicProfile) {
                  <span class="badge badge-success">Perfil Público</span>
                } @else {
                  <span class="badge badge-secondary">Perfil Privado</span>
                }
              </div>
            </div>
          </mat-card>
        </div>
      </div>

      <!-- Profile Form -->
      <div class="row clearfix">
        <div class="col-lg-12">
          <mat-card>
            <mat-card-content>
              <form [formGroup]="profileForm">
                <mat-tab-group>
                  <!-- Información Personal -->
                  <mat-tab>
                    <ng-template mat-tab-label>
                      <mat-icon class="material-icons-outlined">person</mat-icon>
                      Información Personal
                    </ng-template>
                    <div class="tab-content">
                      <div class="row">
                        <div class="col-md-6">
                          <mat-form-field class="full-width" appearance="outline">
                            <mat-label>Nombre</mat-label>
                            <input matInput formControlName="firstName">
                          </mat-form-field>
                        </div>
                        <div class="col-md-6">
                          <mat-form-field class="full-width" appearance="outline">
                            <mat-label>Apellido</mat-label>
                            <input matInput formControlName="lastName">
                          </mat-form-field>
                        </div>
                        <div class="col-md-6">
                          <mat-form-field class="full-width" appearance="outline">
                            <mat-label>Especialidad</mat-label>
                            <input matInput formControlName="specialty">
                          </mat-form-field>
                        </div>
                        <div class="col-md-6">
                          <mat-form-field class="full-width" appearance="outline">
                            <mat-label>Subespecialidades (separadas por coma)</mat-label>
                            <input matInput formControlName="subspecialties">
                          </mat-form-field>
                        </div>
                        <div class="col-md-6">
                          <mat-form-field class="full-width" appearance="outline">
                            <mat-label>Número de Colegiatura (CMP)</mat-label>
                            <input matInput formControlName="licenseNumber">
                            <mat-hint>Ej: 123456</mat-hint>
                          </mat-form-field>
                        </div>
                        <div class="col-md-6">
                          <mat-form-field class="full-width" appearance="outline">
                            <mat-label>Registro Nacional de Especialidad (RNE)</mat-label>
                            <input matInput formControlName="rne">
                            <mat-hint>Ej: 12345</mat-hint>
                          </mat-form-field>
                        </div>
                        <div class="col-md-6">
                          <mat-form-field class="full-width" appearance="outline">
                            <mat-label>Teléfono</mat-label>
                            <input matInput formControlName="phone">
                          </mat-form-field>
                        </div>
                        <div class="col-md-6">
                          <mat-form-field class="full-width" appearance="outline">
                            <mat-label>Email</mat-label>
                            <input matInput formControlName="email" type="email">
                          </mat-form-field>
                        </div>
                        <div class="col-md-6">
                          <mat-form-field class="full-width" appearance="outline">
                            <mat-label>Ciudad</mat-label>
                            <input matInput formControlName="city">
                          </mat-form-field>
                        </div>
                        <div class="col-md-6">
                          <mat-form-field class="full-width" appearance="outline">
                            <mat-label>País</mat-label>
                            <input matInput formControlName="country">
                          </mat-form-field>
                        </div>
                        <div class="col-md-6">
                          <mat-form-field class="full-width" appearance="outline">
                            <mat-label>Dirección</mat-label>
                            <input matInput formControlName="address">
                          </mat-form-field>
                        </div>
                        <div class="col-md-4">
                          <mat-form-field class="full-width" appearance="outline">
                            <mat-label>Tarifa de Consulta</mat-label>
                            <input matInput formControlName="consultationFee" type="number">
                          </mat-form-field>
                        </div>
                        <div class="col-md-2">
                          <mat-form-field class="full-width" appearance="outline">
                            <mat-label>Moneda</mat-label>
                            <mat-select formControlName="currency">
                              <mat-option value="PEN">PEN</mat-option>
                              <mat-option value="USD">USD</mat-option>
                              <mat-option value="EUR">EUR</mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>
                        <div class="col-md-12">
                          <mat-form-field class="full-width" appearance="outline">
                            <mat-label>Biografía</mat-label>
                            <textarea matInput formControlName="bio" rows="4"></textarea>
                          </mat-form-field>
                        </div>
                        <div class="col-md-12">
                          <mat-checkbox formControlName="isPublicProfile" color="primary">
                            Mostrar perfil en directorio público
                          </mat-checkbox>
                        </div>
                      </div>
                    </div>
                  </mat-tab>

                  <!-- Educación -->
                  <mat-tab>
                    <ng-template mat-tab-label>
                      <mat-icon class="material-icons-outlined">school</mat-icon>
                      Educación
                    </ng-template>
                    <div class="tab-content">
                      <div class="section-header">
                        <h4>Formación Académica</h4>
                        <button mat-raised-button color="primary" (click)="addEducation()">
                          <mat-icon>add</mat-icon> Agregar
                        </button>
                      </div>

                      <div formArrayName="education">
                        @for (edu of education.controls; track trackByIndex($index); let i = $index) {
                          <div class="array-item" [formGroupName]="i">
                            <div class="row">
                              <div class="col-md-4">
                                <mat-form-field class="full-width" appearance="outline">
                                  <mat-label>Institución</mat-label>
                                  <input matInput formControlName="institution">
                                </mat-form-field>
                              </div>
                              <div class="col-md-4">
                                <mat-form-field class="full-width" appearance="outline">
                                  <mat-label>Grado/Título</mat-label>
                                  <input matInput formControlName="degree">
                                </mat-form-field>
                              </div>
                              <div class="col-md-2">
                                <mat-form-field class="full-width" appearance="outline">
                                  <mat-label>Año</mat-label>
                                  <input matInput formControlName="year" type="number">
                                </mat-form-field>
                              </div>
                              <div class="col-md-2 d-flex align-items-center">
                                <button mat-icon-button color="warn" (click)="removeEducation(i)">
                                  <mat-icon>delete</mat-icon>
                                </button>
                              </div>
                            </div>
                          </div>
                        }
                      </div>

                      @if (education.length === 0) {
                        <p class="no-items">No hay educación registrada</p>
                      }
                    </div>
                  </mat-tab>

                  <!-- Experiencia -->
                  <mat-tab>
                    <ng-template mat-tab-label>
                      <mat-icon class="material-icons-outlined">work</mat-icon>
                      Experiencia
                    </ng-template>
                    <div class="tab-content">
                      <div class="section-header">
                        <h4>Experiencia Laboral</h4>
                        <button mat-raised-button color="primary" (click)="addExperience()">
                          <mat-icon>add</mat-icon> Agregar
                        </button>
                      </div>

                      <div formArrayName="experience">
                        @for (exp of experience.controls; track trackByIndex($index); let i = $index) {
                          <div class="array-item" [formGroupName]="i">
                            <div class="row">
                              <div class="col-md-4">
                                <mat-form-field class="full-width" appearance="outline">
                                  <mat-label>Cargo</mat-label>
                                  <input matInput formControlName="position">
                                </mat-form-field>
                              </div>
                              <div class="col-md-4">
                                <mat-form-field class="full-width" appearance="outline">
                                  <mat-label>Institución</mat-label>
                                  <input matInput formControlName="institution">
                                </mat-form-field>
                              </div>
                              <div class="col-md-2">
                                <mat-form-field class="full-width" appearance="outline">
                                  <mat-label>Desde</mat-label>
                                  <input matInput formControlName="startYear" type="number">
                                </mat-form-field>
                              </div>
                              <div class="col-md-2">
                                <mat-form-field class="full-width" appearance="outline">
                                  <mat-label>Hasta</mat-label>
                                  <input matInput formControlName="endYear" type="number">
                                </mat-form-field>
                              </div>
                              <div class="col-md-10">
                                <mat-form-field class="full-width" appearance="outline">
                                  <mat-label>Descripción</mat-label>
                                  <textarea matInput formControlName="description" rows="2"></textarea>
                                </mat-form-field>
                              </div>
                              <div class="col-md-2 d-flex align-items-center">
                                <button mat-icon-button color="warn" (click)="removeExperience(i)">
                                  <mat-icon>delete</mat-icon>
                                </button>
                              </div>
                            </div>
                          </div>
                        }
                      </div>

                      @if (experience.length === 0) {
                        <p class="no-items">No hay experiencia registrada</p>
                      }
                    </div>
                  </mat-tab>

                  <!-- Certificaciones -->
                  <mat-tab>
                    <ng-template mat-tab-label>
                      <mat-icon class="material-icons-outlined">card_membership</mat-icon>
                      Certificaciones
                    </ng-template>
                    <div class="tab-content">
                      <div class="section-header">
                        <h4>Certificaciones y Licencias</h4>
                        <button mat-raised-button color="primary" (click)="addCertification()">
                          <mat-icon>add</mat-icon> Agregar
                        </button>
                      </div>

                      <div formArrayName="certifications">
                        @for (cert of certifications.controls; track trackByIndex($index); let i = $index) {
                          <div class="array-item" [formGroupName]="i">
                            <div class="row">
                              <div class="col-md-3">
                                <mat-form-field class="full-width" appearance="outline">
                                  <mat-label>Nombre</mat-label>
                                  <input matInput formControlName="name">
                                </mat-form-field>
                              </div>
                              <div class="col-md-3">
                                <mat-form-field class="full-width" appearance="outline">
                                  <mat-label>Emisor</mat-label>
                                  <input matInput formControlName="issuer">
                                </mat-form-field>
                              </div>
                              <div class="col-md-2">
                                <mat-form-field class="full-width" appearance="outline">
                                  <mat-label>Año</mat-label>
                                  <input matInput formControlName="year" type="number">
                                </mat-form-field>
                              </div>
                              <div class="col-md-2">
                                <mat-form-field class="full-width" appearance="outline">
                                  <mat-label>Nº Licencia</mat-label>
                                  <input matInput formControlName="licenseNumber">
                                </mat-form-field>
                              </div>
                              <div class="col-md-2 d-flex align-items-center">
                                <button mat-icon-button color="warn" (click)="removeCertification(i)">
                                  <mat-icon>delete</mat-icon>
                                </button>
                              </div>
                            </div>
                          </div>
                        }
                      </div>

                      @if (certifications.length === 0) {
                        <p class="no-items">No hay certificaciones registradas</p>
                      }
                    </div>
                  </mat-tab>

                  <!-- CV -->
                  <mat-tab>
                    <ng-template mat-tab-label>
                      <mat-icon class="material-icons-outlined">description</mat-icon>
                      Curriculum Vitae
                    </ng-template>
                    <div class="tab-content">
                      <div class="cv-section">
                        <h4>Subir Curriculum Vitae</h4>
                        <p class="text-muted">Sube tu CV en formato PDF o DOCX (máximo 10MB)</p>

                        <div class="cv-upload-area">
                          @if (doctorProfile?.cvUrl) {
                            <div class="cv-file">
                              <mat-icon>description</mat-icon>
                              <span>{{ cvFileName }}</span>
                              <button mat-icon-button color="warn" (click)="deleteCv()">
                                <mat-icon>delete</mat-icon>
                              </button>
                            </div>
                            <a [href]="doctorProfile?.cvUrl" target="_blank" mat-stroked-button color="primary">
                              <mat-icon>visibility</mat-icon> Ver CV
                            </a>
                          } @else {
                            <input type="file"
                                   #cvInput
                                   hidden
                                   accept=".pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                                   (change)="onCvFileSelected($event)">
                            <button mat-raised-button color="primary" (click)="cvInput.click()" [disabled]="isUploadingCv">
                              @if (isUploadingCv) {
                                <mat-spinner diameter="20"></mat-spinner>
                              } @else {
                                <mat-icon>upload_file</mat-icon> Subir CV
                              }
                            </button>
                          }
                        </div>
                      </div>
                    </div>
                  </mat-tab>
                </mat-tab-group>
              </form>
            </mat-card-content>
            <mat-card-actions align="end">
              <button mat-raised-button color="primary" (click)="saveProfile()" [disabled]="isSaving">
                @if (isSaving) {
                  <mat-spinner diameter="20"></mat-spinner>
                } @else {
                  <mat-icon>save</mat-icon> Guardar Cambios
                }
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </div>
    }
  </div>
</section>
