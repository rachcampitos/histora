<div class="appointment-form-dialog">
  <h2 mat-dialog-title>{{ dialogTitle | translate }}</h2>

  <mat-dialog-content>
    <form [formGroup]="appointmentForm">
      <!-- Patient Selection -->
      <div class="row">
        <div class="col-12">
          <mat-form-field class="w-100">
            <mat-label>{{ 'APPOINTMENTS.FORM.SELECT_PATIENT' | translate }}</mat-label>
            <input
              matInput
              [matAutocomplete]="patientAuto"
              [formControl]="patientControl"
              [placeholder]="'PATIENTS.SEARCH_PLACEHOLDER' | translate"
            />
            <mat-autocomplete
              #patientAuto="matAutocomplete"
              [displayWith]="displayPatient"
              (optionSelected)="onPatientSelected($event.option.value)"
            >
              @for (patient of filteredPatients$ | async; track patient._id) {
                <mat-option [value]="patient">
                  {{ patient.firstName }} {{ patient.lastName }}
                  @if (patient.email) {
                    <span class="patient-email"> - {{ patient.email }}</span>
                  }
                </mat-option>
              }
            </mat-autocomplete>
            @if (isLoadingPatients) {
              <mat-spinner matSuffix [diameter]="20"></mat-spinner>
            }
            @if (appointmentForm.get('patientId')?.hasError('required') && appointmentForm.get('patientId')?.touched) {
              <mat-error>{{ 'VALIDATION.REQUIRED' | translate }}</mat-error>
            }
          </mat-form-field>
        </div>
      </div>

      <!-- Date and Time -->
      <div class="row">
        <div class="col-md-4">
          <mat-form-field class="w-100">
            <mat-label>{{ 'APPOINTMENTS.FORM.SELECT_DATE' | translate }}</mat-label>
            <input
              matInput
              [matDatepicker]="picker"
              formControlName="scheduledDate"
              [min]="minDate"
            />
            <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            @if (appointmentForm.get('scheduledDate')?.hasError('required')) {
              <mat-error>{{ 'VALIDATION.REQUIRED' | translate }}</mat-error>
            }
          </mat-form-field>
        </div>
        <div class="col-md-4">
          <mat-form-field class="w-100">
            <mat-label>{{ 'APPOINTMENTS.FORM.START_TIME' | translate }}</mat-label>
            <mat-select formControlName="startTime" (selectionChange)="onStartTimeChange()">
              @for (time of timeSlots; track time) {
                <mat-option [value]="time">{{ time }}</mat-option>
              }
            </mat-select>
            @if (appointmentForm.get('startTime')?.hasError('required')) {
              <mat-error>{{ 'VALIDATION.REQUIRED' | translate }}</mat-error>
            }
          </mat-form-field>
        </div>
        <div class="col-md-4">
          <mat-form-field class="w-100">
            <mat-label>{{ 'APPOINTMENTS.FORM.END_TIME' | translate }}</mat-label>
            <mat-select formControlName="endTime">
              @for (time of timeSlots; track time) {
                <mat-option [value]="time">{{ time }}</mat-option>
              }
            </mat-select>
            @if (appointmentForm.get('endTime')?.hasError('required')) {
              <mat-error>{{ 'VALIDATION.REQUIRED' | translate }}</mat-error>
            }
          </mat-form-field>
        </div>
      </div>

      <!-- Status (only for edit) -->
      @if (action === 'edit') {
        <div class="row">
          <div class="col-md-6">
            <mat-form-field class="w-100">
              <mat-label>{{ 'APPOINTMENTS.TABLE.STATUS' | translate }}</mat-label>
              <mat-select formControlName="status">
                @for (option of statusOptions; track option.value) {
                  <mat-option [value]="option.value">{{ option.label | translate }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        </div>
      }

      <!-- Reason and Notes -->
      <div class="row">
        <div class="col-12">
          <mat-form-field class="w-100">
            <mat-label>{{ 'APPOINTMENTS.FORM.REASON' | translate }}</mat-label>
            <input matInput formControlName="reasonForVisit" />
          </mat-form-field>
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <mat-form-field class="w-100">
            <mat-label>{{ 'APPOINTMENTS.FORM.NOTES' | translate }}</mat-label>
            <textarea matInput formControlName="notes" rows="3"></textarea>
          </mat-form-field>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="onCancel()">{{ 'COMMON.ACTIONS.CANCEL' | translate }}</button>
    <button
      mat-flat-button
      color="primary"
      (click)="onSubmit()"
      [disabled]="appointmentForm.invalid || isSubmitting"
    >
      {{ 'COMMON.ACTIONS.SAVE' | translate }}
    </button>
  </mat-dialog-actions>
</div>
