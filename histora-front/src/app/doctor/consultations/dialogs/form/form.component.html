<div class="consultation-dialog">
  <!-- Header -->
  <div class="dialog-header">
    <div class="header-info">
      <h2>{{ 'CONSULTATIONS.CLINICAL_HISTORY' | translate }}</h2>
      <div class="patient-badge">
        <mat-icon>person</mat-icon>
        <span class="patient-name">{{ getPatientName() }}</span>
        @if (getPatientAge()) {
        <span class="patient-age">({{ getPatientAge() }} {{ 'COMMON.YEARS' | translate }})</span>
        }
        @if (consultation.patient?.gender) {
        <span class="patient-gender">- {{ consultation.patient?.gender }}</span>
        }
      </div>
    </div>
    <button mat-icon-button (click)="close()" [disabled]="isSaving">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-divider></mat-divider>

  <!-- Form Content -->
  <div class="dialog-content">
    <form [formGroup]="consultationForm">
      <mat-tab-group animationDuration="200ms">
        <!-- Tab 1: Motivo y Enfermedad Actual -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>medical_information</mat-icon>
            {{ 'CONSULTATIONS.TABS.REASON' | translate }}
          </ng-template>
          <div class="tab-content">
            <p class="section-note">
              <mat-icon>info</mat-icon>
              {{ 'CONSULTATIONS.MINSA_NOTE' | translate }}
            </p>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'CONSULTATIONS.CHIEF_COMPLAINT' | translate }} *</mat-label>
              <textarea matInput formControlName="chiefComplaint" rows="3"
                placeholder="{{ 'CONSULTATIONS.CHIEF_COMPLAINT_PLACEHOLDER' | translate }}"></textarea>
              @if (consultationForm.get('chiefComplaint')?.hasError('required')) {
              <mat-error>{{ 'CONSULTATIONS.ERRORS.CHIEF_COMPLAINT_REQUIRED' | translate }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'CONSULTATIONS.HISTORY_PRESENT_ILLNESS' | translate }} *</mat-label>
              <textarea matInput formControlName="historyOfPresentIllness" rows="5"
                placeholder="{{ 'CONSULTATIONS.HISTORY_PRESENT_ILLNESS_PLACEHOLDER' | translate }}"></textarea>
              @if (consultationForm.get('historyOfPresentIllness')?.hasError('required')) {
              <mat-error>{{ 'CONSULTATIONS.ERRORS.HPI_REQUIRED' | translate }}</mat-error>
              }
            </mat-form-field>
          </div>
        </mat-tab>

        <!-- Tab 2: Antecedentes -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>history</mat-icon>
            {{ 'CONSULTATIONS.TABS.HISTORY' | translate }}
          </ng-template>
          <div class="tab-content">
            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>{{ 'CONSULTATIONS.PAST_MEDICAL_HISTORY' | translate }}</mat-label>
                <textarea matInput formControlName="pastMedicalHistory" rows="3"
                  placeholder="{{ 'CONSULTATIONS.PAST_MEDICAL_HISTORY_PLACEHOLDER' | translate }}"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>{{ 'CONSULTATIONS.FAMILY_HISTORY' | translate }}</mat-label>
                <textarea matInput formControlName="familyHistory" rows="3"
                  placeholder="{{ 'CONSULTATIONS.FAMILY_HISTORY_PLACEHOLDER' | translate }}"></textarea>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>{{ 'CONSULTATIONS.SOCIAL_HISTORY' | translate }}</mat-label>
                <textarea matInput formControlName="socialHistory" rows="3"
                  placeholder="{{ 'CONSULTATIONS.SOCIAL_HISTORY_PLACEHOLDER' | translate }}"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>{{ 'CONSULTATIONS.ALLERGIES' | translate }}</mat-label>
                <textarea matInput formControlName="allergies" rows="3"
                  placeholder="{{ 'CONSULTATIONS.ALLERGIES_PLACEHOLDER' | translate }}"></textarea>
              </mat-form-field>
            </div>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'CONSULTATIONS.CURRENT_MEDICATIONS' | translate }}</mat-label>
              <textarea matInput formControlName="currentMedications" rows="3"
                placeholder="{{ 'CONSULTATIONS.CURRENT_MEDICATIONS_PLACEHOLDER' | translate }}"></textarea>
            </mat-form-field>
          </div>
        </mat-tab>

        <!-- Tab 3: Examen Físico -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>monitor_heart</mat-icon>
            {{ 'CONSULTATIONS.TABS.PHYSICAL_EXAM' | translate }}
          </ng-template>
          <div class="tab-content" formGroupName="physicalExamination">
            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.GENERAL' | translate }}</mat-label>
                <textarea matInput formControlName="generalAppearance" rows="2"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.HEAD' | translate }}</mat-label>
                <textarea matInput formControlName="head" rows="2"></textarea>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="third-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.EYES' | translate }}</mat-label>
                <textarea matInput formControlName="eyes" rows="2"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="third-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.EARS' | translate }}</mat-label>
                <textarea matInput formControlName="ears" rows="2"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="third-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.NOSE' | translate }}</mat-label>
                <textarea matInput formControlName="nose" rows="2"></textarea>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="third-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.THROAT' | translate }}</mat-label>
                <textarea matInput formControlName="throat" rows="2"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="third-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.NECK' | translate }}</mat-label>
                <textarea matInput formControlName="neck" rows="2"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="third-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.CHEST' | translate }}</mat-label>
                <textarea matInput formControlName="chest" rows="2"></textarea>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.LUNGS' | translate }}</mat-label>
                <textarea matInput formControlName="lungs" rows="2"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.HEART' | translate }}</mat-label>
                <textarea matInput formControlName="heart" rows="2"></textarea>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="half-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.ABDOMEN' | translate }}</mat-label>
                <textarea matInput formControlName="abdomen" rows="2"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="half-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.EXTREMITIES' | translate }}</mat-label>
                <textarea matInput formControlName="extremities" rows="2"></textarea>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="third-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.SKIN' | translate }}</mat-label>
                <textarea matInput formControlName="skin" rows="2"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="third-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.NEUROLOGICAL' | translate }}</mat-label>
                <textarea matInput formControlName="neurological" rows="2"></textarea>
              </mat-form-field>

              <mat-form-field appearance="outline" class="third-width">
                <mat-label>{{ 'CONSULTATIONS.EXAM.MUSCULOSKELETAL' | translate }}</mat-label>
                <textarea matInput formControlName="musculoskeletal" rows="2"></textarea>
              </mat-form-field>
            </div>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'CONSULTATIONS.EXAM.OTHER' | translate }}</mat-label>
              <textarea matInput formControlName="other" rows="2"></textarea>
            </mat-form-field>
          </div>
        </mat-tab>

        <!-- Tab 4: Diagnósticos (CIE-10) -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>biotech</mat-icon>
            {{ 'CONSULTATIONS.TABS.DIAGNOSIS' | translate }}
          </ng-template>
          <div class="tab-content">
            <p class="section-note">
              <mat-icon>info</mat-icon>
              {{ 'CONSULTATIONS.DIAGNOSIS_CIE10_NOTE' | translate }}
            </p>

            <div class="array-header">
              <h4>{{ 'CONSULTATIONS.DIAGNOSES' | translate }} *</h4>
              @if (!isReadOnly) {
              <button mat-stroked-button color="primary" type="button" (click)="addDiagnosis()">
                <mat-icon>add</mat-icon>
                {{ 'CONSULTATIONS.ADD_DIAGNOSIS' | translate }}
              </button>
              }
            </div>

            @if (diagnoses.length === 0) {
            <div class="empty-array">
              <mat-icon>warning</mat-icon>
              <span>{{ 'CONSULTATIONS.NO_DIAGNOSES' | translate }}</span>
            </div>
            }

            @for (diagnosis of diagnoses.controls; track diagnosis; let i = $index) {
            <div class="array-item" [formGroupName]="'diagnoses'">
              <div class="array-item-content" [formGroupName]="i">
                <div class="form-row">
                  <mat-form-field appearance="outline" class="code-field">
                    <mat-label>{{ 'CONSULTATIONS.DIAGNOSIS.CODE' | translate }} (CIE-10)</mat-label>
                    <input matInput formControlName="code" placeholder="Ej: J00">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="flex-field">
                    <mat-label>{{ 'CONSULTATIONS.DIAGNOSIS.DESCRIPTION' | translate }}</mat-label>
                    <input matInput formControlName="description">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="type-field">
                    <mat-label>{{ 'CONSULTATIONS.DIAGNOSIS.TYPE' | translate }}</mat-label>
                    <mat-select formControlName="type">
                      @for (type of diagnosisTypes; track type.value) {
                      <mat-option [value]="type.value">{{ type.label | translate }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>

                  @if (!isReadOnly) {
                  <button mat-icon-button color="warn" type="button" (click)="removeDiagnosis(i)"
                    matTooltip="{{ 'COMMON.DELETE' | translate }}">
                    <mat-icon>delete</mat-icon>
                  </button>
                  }
                </div>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>{{ 'CONSULTATIONS.DIAGNOSIS.NOTES' | translate }}</mat-label>
                  <input matInput formControlName="notes">
                </mat-form-field>
              </div>
            </div>
            }
          </div>
        </mat-tab>

        <!-- Tab 5: Tratamiento y Recetas -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>medication</mat-icon>
            {{ 'CONSULTATIONS.TABS.TREATMENT' | translate }}
          </ng-template>
          <div class="tab-content">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'CONSULTATIONS.TREATMENT_PLAN' | translate }}</mat-label>
              <textarea matInput formControlName="treatmentPlan" rows="4"
                placeholder="{{ 'CONSULTATIONS.TREATMENT_PLAN_PLACEHOLDER' | translate }}"></textarea>
            </mat-form-field>

            <mat-divider></mat-divider>

            <div class="array-header">
              <h4>{{ 'CONSULTATIONS.PRESCRIPTIONS' | translate }}</h4>
              @if (!isReadOnly) {
              <button mat-stroked-button color="primary" type="button" (click)="addPrescription()">
                <mat-icon>add</mat-icon>
                {{ 'CONSULTATIONS.ADD_PRESCRIPTION' | translate }}
              </button>
              }
            </div>

            @if (prescriptions.length === 0) {
            <div class="empty-array optional">
              <mat-icon>info_outline</mat-icon>
              <span>{{ 'CONSULTATIONS.NO_PRESCRIPTIONS' | translate }}</span>
            </div>
            }

            @for (prescription of prescriptions.controls; track prescription; let i = $index) {
            <div class="array-item prescription-item" [formGroupName]="'prescriptions'">
              <div class="array-item-content" [formGroupName]="i">
                <div class="form-row">
                  <mat-form-field appearance="outline" class="flex-field">
                    <mat-label>{{ 'CONSULTATIONS.PRESCRIPTION.MEDICATION' | translate }}</mat-label>
                    <input matInput formControlName="medication">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="small-field">
                    <mat-label>{{ 'CONSULTATIONS.PRESCRIPTION.DOSAGE' | translate }}</mat-label>
                    <input matInput formControlName="dosage" placeholder="Ej: 500mg">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="small-field">
                    <mat-label>{{ 'CONSULTATIONS.PRESCRIPTION.FREQUENCY' | translate }}</mat-label>
                    <input matInput formControlName="frequency" placeholder="Ej: c/8h">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="small-field">
                    <mat-label>{{ 'CONSULTATIONS.PRESCRIPTION.DURATION' | translate }}</mat-label>
                    <input matInput formControlName="duration" placeholder="Ej: 7 días">
                  </mat-form-field>

                  @if (!isReadOnly) {
                  <button mat-icon-button color="warn" type="button" (click)="removePrescription(i)">
                    <mat-icon>delete</mat-icon>
                  </button>
                  }
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="route-field">
                    <mat-label>{{ 'CONSULTATIONS.PRESCRIPTION.ROUTE' | translate }}</mat-label>
                    <mat-select formControlName="route">
                      @for (route of medicationRoutes; track route) {
                      <mat-option [value]="route">{{ route }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="flex-field">
                    <mat-label>{{ 'CONSULTATIONS.PRESCRIPTION.INSTRUCTIONS' | translate }}</mat-label>
                    <input matInput formControlName="instructions">
                  </mat-form-field>

                  <mat-checkbox formControlName="isControlled" class="controlled-checkbox">
                    {{ 'CONSULTATIONS.PRESCRIPTION.CONTROLLED' | translate }}
                  </mat-checkbox>
                </div>
              </div>
            </div>
            }
          </div>
        </mat-tab>

        <!-- Tab 6: Exámenes y Seguimiento -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon>science</mat-icon>
            {{ 'CONSULTATIONS.TABS.EXAMS' | translate }}
          </ng-template>
          <div class="tab-content">
            <div class="array-header">
              <h4>{{ 'CONSULTATIONS.ORDERED_EXAMS' | translate }}</h4>
              @if (!isReadOnly) {
              <button mat-stroked-button color="primary" type="button" (click)="addOrderedExam()">
                <mat-icon>add</mat-icon>
                {{ 'CONSULTATIONS.ADD_EXAM' | translate }}
              </button>
              }
            </div>

            @if (orderedExams.length === 0) {
            <div class="empty-array optional">
              <mat-icon>info_outline</mat-icon>
              <span>{{ 'CONSULTATIONS.NO_EXAMS' | translate }}</span>
            </div>
            }

            @for (exam of orderedExams.controls; track exam; let i = $index) {
            <div class="array-item" [formGroupName]="'orderedExams'">
              <div class="array-item-content" [formGroupName]="i">
                <div class="form-row">
                  <mat-form-field appearance="outline" class="flex-field">
                    <mat-label>{{ 'CONSULTATIONS.EXAM_NAME' | translate }}</mat-label>
                    <input matInput formControlName="name">
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="type-field">
                    <mat-label>{{ 'CONSULTATIONS.EXAM_TYPE' | translate }}</mat-label>
                    <mat-select formControlName="type">
                      @for (type of examTypes; track type) {
                      <mat-option [value]="type">{{ type }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>

                  <mat-checkbox formControlName="isUrgent" class="urgent-checkbox">
                    {{ 'CONSULTATIONS.URGENT' | translate }}
                  </mat-checkbox>

                  @if (!isReadOnly) {
                  <button mat-icon-button color="warn" type="button" (click)="removeOrderedExam(i)">
                    <mat-icon>delete</mat-icon>
                  </button>
                  }
                </div>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>{{ 'CONSULTATIONS.EXAM_INSTRUCTIONS' | translate }}</mat-label>
                  <input matInput formControlName="instructions">
                </mat-form-field>
              </div>
            </div>
            }

            <mat-divider></mat-divider>

            <h4 class="section-title">{{ 'CONSULTATIONS.FOLLOWUP' | translate }}</h4>

            <div class="form-row">
              <mat-form-field appearance="outline" class="date-field">
                <mat-label>{{ 'CONSULTATIONS.FOLLOWUP_DATE' | translate }}</mat-label>
                <input matInput [matDatepicker]="followUpPicker" formControlName="followUpDate">
                <mat-datepicker-toggle matSuffix [for]="followUpPicker"></mat-datepicker-toggle>
                <mat-datepicker #followUpPicker></mat-datepicker>
              </mat-form-field>

              <mat-form-field appearance="outline" class="flex-field">
                <mat-label>{{ 'CONSULTATIONS.FOLLOWUP_INSTRUCTIONS' | translate }}</mat-label>
                <textarea matInput formControlName="followUpInstructions" rows="2"></textarea>
              </mat-form-field>
            </div>

            <mat-form-field appearance="outline" class="full-width">
              <mat-label>{{ 'CONSULTATIONS.CLINICAL_NOTES' | translate }}</mat-label>
              <textarea matInput formControlName="clinicalNotes" rows="4"
                placeholder="{{ 'CONSULTATIONS.CLINICAL_NOTES_PLACEHOLDER' | translate }}"></textarea>
            </mat-form-field>
          </div>
        </mat-tab>
      </mat-tab-group>
    </form>
  </div>

  <mat-divider></mat-divider>

  <!-- Footer Actions -->
  <div class="dialog-footer">
    <button mat-stroked-button (click)="close()" [disabled]="isSaving">
      {{ 'COMMON.CANCEL' | translate }}
    </button>

    @if (!isReadOnly) {
    <div class="action-buttons">
      <button mat-stroked-button color="primary" (click)="saveAndContinue()" [disabled]="isSaving">
        @if (isSaving) {
        <mat-spinner diameter="20"></mat-spinner>
        } @else {
        <mat-icon>save</mat-icon>
        {{ 'CONSULTATIONS.SAVE_CONTINUE' | translate }}
        }
      </button>

      <button mat-raised-button color="primary" (click)="saveAndComplete()" [disabled]="isSaving">
        @if (isSaving) {
        <mat-spinner diameter="20"></mat-spinner>
        } @else {
        <mat-icon>check_circle</mat-icon>
        {{ 'CONSULTATIONS.COMPLETE' | translate }}
        }
      </button>
    </div>
    }
  </div>
</div>
