<!-- FAB Button -->
<button
  class="ai-fab"
  [class.active]="isOpen"
  aria-label="Abrir Asistente de Salud AI"
  [attr.aria-expanded]="isOpen"
  aria-haspopup="dialog"
  (click)="openAssistant()">
  <svg class="ai-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  <span class="pulse-ring" *ngIf="!isOpen" aria-hidden="true"></span>
</button>

<!-- Full Screen Overlay -->
<div
  class="ai-assistant-overlay"
  *ngIf="isOpen"
  [@overlayAnimation]="isOpen ? 'active' : 'inactive'"
  role="dialog"
  aria-modal="true"
  aria-labelledby="ai-assistant-title">

  <!-- Edge Glow Effect (Siri-like) -->
  <div class="edge-glow-container" aria-hidden="true">
    <div class="edge-glow"
         [class.listening]="state === 'listening' || isListening"
         [class.processing]="state === 'processing'"
         [class.speaking]="state === 'speaking'">
    </div>
    <div class="glow-layer-1"></div>
    <div class="glow-layer-2"></div>

    <!-- Particle effect for extra futurism -->
    <div class="particle-field">
      <span class="particle" *ngFor="let i of [1,2,3,4,5,6,7,8,9,10,11,12]"></span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="ai-assistant-content">

    <!-- Header -->
    <div class="ai-header">
      <div class="ai-avatar" [class.active]="state !== 'inactive'">
        <div class="avatar-glow"></div>
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"
                fill="currentColor"/>
        </svg>
      </div>
      <div class="ai-title-container">
        <h2 id="ai-assistant-title" class="ai-title">Hana</h2>
        <span class="ai-subtitle">Asistente de Salud</span>
      </div>
      <button
        class="close-button"
        aria-label="Cerrar Asistente AI"
        (click)="closeAssistant()">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>

    <!-- Status Indicator -->
    <div class="ai-status" aria-live="polite" aria-atomic="true">
      <span *ngIf="isListening" class="status-badge listening">
        <span class="voice-wave">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </span>
        Escuchando...
      </span>
      <span *ngIf="state === 'processing'" class="status-badge processing">
        <span class="loading-dots">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </span>
        Pensando...
      </span>
      <span *ngIf="state === 'speaking'" class="status-badge speaking">
        <svg class="speaker-icon" viewBox="0 0 24 24" fill="none">
          <path d="M11 5L6 9H2V15H6L11 19V5Z" stroke="currentColor" stroke-width="2"/>
          <path d="M15.54 8.46C16.48 9.4 17 10.67 17 12C17 13.33 16.48 14.6 15.54 15.54" stroke="currentColor" stroke-width="2"/>
        </svg>
        Hablando...
      </span>
    </div>

    <!-- Chat Container -->
    <div
      #chatContainer
      class="chat-container"
      role="log"
      aria-label="Mensajes del chat">

      <!-- Welcome Message -->
      <div class="welcome-message" *ngIf="messages.length === 0">
        <div class="welcome-icon">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"
                  fill="currentColor"/>
          </svg>
        </div>
        <h3>¡Hola! Soy Hana</h3>
        <p>Tu asistente de salud virtual. ¿En qué puedo ayudarte hoy?</p>

        <!-- Suggested Actions -->
        <div class="suggested-actions">
          <button
            *ngFor="let action of suggestedActions"
            class="action-chip"
            (click)="sendMessage(action.command)"
            [attr.aria-label]="action.label">
            <svg class="action-icon" viewBox="0 0 24 24" fill="none">
              <ng-container [ngSwitch]="action.icon">
                <path *ngSwitchCase="'calendar-outline'" d="M19 4H5C3.89543 4 3 4.89543 3 6V20C3 21.1046 3.89543 22 5 22H19C20.1046 22 21 21.1046 21 20V6C21 4.89543 20.1046 4 19 4Z M16 2V6 M8 2V6 M3 10H21" stroke="currentColor" stroke-width="2"/>
                <path *ngSwitchCase="'medkit-outline'" d="M4 5C4 3.89543 4.89543 3 6 3H18C19.1046 3 20 3.89543 20 5V8H4V5Z M4 8H20V19C20 20.1046 19.1046 21 18 21H6C4.89543 21 4 20.1046 4 19V8Z M12 11V17 M9 14H15" stroke="currentColor" stroke-width="2"/>
                <path *ngSwitchCase="'help-circle-outline'" d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z M9.09 9C9.3251 8.33167 9.78915 7.76811 10.4 7.40913C11.0108 7.05016 11.7289 6.91894 12.4272 7.03871C13.1255 7.15849 13.7588 7.52152 14.2151 8.06353C14.6713 8.60553 14.9211 9.29152 14.92 10C14.92 12 11.92 13 11.92 13 M12 17H12.01" stroke="currentColor" stroke-width="2"/>
                <path *ngSwitchDefault d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z M12 16V12 M12 8H12.01" stroke="currentColor" stroke-width="2"/>
              </ng-container>
            </svg>
            <span>{{ action.label }}</span>
          </button>
        </div>
      </div>

      <!-- Messages -->
      <div
        *ngFor="let message of messages; trackBy: trackByMessageId"
        class="message-wrapper"
        [class.user]="message.role === 'user'"
        [class.assistant]="message.role === 'assistant'"
        [@messageSlide]>

        <div class="chat-bubble" [class.error]="message.isError">
          <p>{{ message.content }}</p>

          <!-- Suggestions -->
          <div class="message-suggestions" *ngIf="message.suggestions?.length">
            <button
              *ngFor="let suggestion of message.suggestions"
              class="suggestion-chip"
              (click)="sendMessage(suggestion)">
              {{ suggestion }}
            </button>
          </div>
        </div>

        <span class="message-time">
          {{ message.timestamp | date:'shortTime' }}
        </span>
      </div>

      <!-- Processing Indicator -->
      <div class="message-wrapper assistant" *ngIf="state === 'processing'">
        <div class="chat-bubble typing-indicator">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="input-container">
      <button
        *ngIf="showVoiceButton"
        class="voice-button"
        [class.active]="isListening"
        [attr.aria-pressed]="isListening"
        aria-label="Entrada de voz"
        (click)="toggleVoiceInput()">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 1C10.34 1 9 2.34 9 4V12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12V4C15 2.34 13.66 1 12 1Z"
                [attr.fill]="isListening ? 'currentColor' : 'none'"
                stroke="currentColor" stroke-width="2"/>
          <path d="M19 10V12C19 15.87 15.87 19 12 19C8.13 19 5 15.87 5 12V10 M12 19V23 M8 23H16"
                stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>

      <textarea
        #messageInput
        class="message-input"
        [(ngModel)]="currentMessage"
        (keydown)="handleKeyDown($event)"
        placeholder="Escribe tu mensaje..."
        aria-label="Entrada de mensaje"
        rows="1"
        [disabled]="state === 'processing'">
      </textarea>

      <button
        class="send-button"
        [disabled]="!currentMessage.trim() || state === 'processing'"
        aria-label="Enviar mensaje"
        (click)="sendMessage()">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M22 2L11 13 M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Screen Reader Live Region -->
  <div role="status" aria-live="polite" aria-atomic="true" class="sr-only">
    {{ latestAIMessage }}
  </div>
</div>
